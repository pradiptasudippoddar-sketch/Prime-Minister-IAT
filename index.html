<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Prime Minister Popularity IAT</title>

    <!-- jsPsych core -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    
    <!-- jsPsych plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.3"></script>

    <!-- jsPsych stylesheet -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Archivo:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --color-primary: #2D3561;
        --color-secondary: #5C7AEA;
        --color-accent: #FF6B9D;
        --color-success: #06D6A0;
        --color-warning: #FFD23F;
        --color-error: #EF476F;
        --color-bg: #F8F9FA;
        --color-surface: #FFFFFF;
        --color-text: #1A1A1A;
        --color-text-light: #6B7280;
        --shadow-sm: 0 2px 8px rgba(45, 53, 97, 0.08);
        --shadow-md: 0 4px 16px rgba(45, 53, 97, 0.12);
        --shadow-lg: 0 8px 32px rgba(45, 53, 97, 0.16);
        --radius: 16px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100%;
        overflow-x: hidden;
        background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: var(--color-text);
        touch-action: manipulation;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      body {
        padding: 20px 10px;
        padding-bottom: 140px;
      }
      
      .jspsych-display-element {
        width: 100%;
        max-width: 100%;
      }
      
      .jspsych-content {
        max-width: 95% !important;
        margin: 0 auto !important;
        padding-bottom: 20px;
      }
      
      .instructions-container {
        max-width: 900px;
        margin: 20px auto;
        background: var(--color-surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .instructions-header {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        color: white;
        padding: 32px 24px;
        text-align: center;
      }
      
      .instructions-header h1 {
        font-family: 'Archivo', sans-serif;
        font-weight: 800;
        font-size: 32px;
        margin: 0 0 12px 0;
        letter-spacing: -0.5px;
      }
      
      .instructions-header p {
        margin: 0;
        opacity: 0.95;
        font-size: 16px;
        font-weight: 400;
      }
      
      .instructions-body {
        padding: 32px 24px;
      }
      
      .instructions-section {
        margin-bottom: 28px;
      }
      
      .instructions-section h2 {
        font-family: 'Archivo', sans-serif;
        font-size: 22px;
        font-weight: 700;
        color: var(--color-primary);
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .instructions-section p, .instructions-section li {
        font-size: 16px;
        line-height: 1.7;
        color: var(--color-text);
        margin: 12px 0;
      }
      
      .instructions-section ul {
        padding-left: 24px;
        margin: 12px 0;
      }
      
      .instructions-section li {
        margin: 10px 0;
        padding-left: 8px;
      }
      
      .category-display {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin: 28px 0;
        flex-wrap: wrap;
      }
      
      .category-card {
        flex: 1;
        min-width: 200px;
        max-width: 280px;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: var(--shadow-md);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      
      .category-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: currentColor;
        opacity: 0.3;
      }
      
      .category-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }
      
      .category-card.left {
        background: linear-gradient(135deg, #06D6A0 0%, #05B187 100%);
        color: white;
      }
      
      .category-card.right {
        background: linear-gradient(135deg, #EF476F 0%, #D63A5C 100%);
        color: white;
      }
      
      .category-card .key-label {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
        margin-bottom: 8px;
      }
      
      .category-card .category-name {
        font-family: 'Archivo', sans-serif;
        font-size: 20px;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .highlight-box {
        background: linear-gradient(135deg, #5C7AEA 0%, #7B92F5 100%);
        color: white;
        padding: 24px;
        border-radius: 12px;
        margin: 24px 0;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
      }
      
      .highlight-box::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse 3s ease-in-out infinite;
      }
      
      .highlight-box h3 {
        font-family: 'Archivo', sans-serif;
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 12px 0;
        position: relative;
      }
      
      .highlight-box p {
        margin: 8px 0;
        font-size: 16px;
        line-height: 1.6;
        position: relative;
      }
      
      .warning-box {
        background: linear-gradient(135deg, #FFD23F 0%, #FFC107 100%);
        color: var(--color-text);
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        border-left: 4px solid #FF9800;
        box-shadow: var(--shadow-md);
      }
      
      .warning-box h3 {
        font-family: 'Archivo', sans-serif;
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .cta-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        color: white;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        text-align: center;
        margin: 24px auto;
        box-shadow: var(--shadow-md);
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-family: 'Poppins', sans-serif;
      }
      
      .cta-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }
      
      /* Touch buttons for mobile */
      .touch-buttons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        padding: 16px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-top: 2px solid var(--color-secondary);
        box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
        z-index: 10000;
        gap: 12px;
      }
      
      .touch-button {
        flex: 1;
        padding: 20px 16px;
        font-size: 16px;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        transition: var(--transition);
        box-shadow: var(--shadow-md);
        font-family: 'Poppins', sans-serif;
        position: relative;
        overflow: hidden;
      }
      
      .touch-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255,255,255,0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }
      
      .touch-button:active::before {
        width: 300px;
        height: 300px;
      }
      
      .touch-button:active {
        transform: scale(0.96);
      }
      
      .touch-button.left {
        background: linear-gradient(135deg, #06D6A0 0%, #05B187 100%);
        color: white;
      }
      
      .touch-button.right {
        background: linear-gradient(135deg, #EF476F 0%, #D63A5C 100%);
        color: white;
      }
      
      .touch-button.center {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        color: white;
      }
      
      .touch-button-key {
        display: block;
        font-size: 20px;
        font-weight: 800;
        margin-bottom: 4px;
        font-family: 'Archivo', sans-serif;
      }
      
      .touch-button-label {
        display: block;
        font-size: 13px;
        opacity: 0.95;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      /* IAT stimuli styling */
      .jspsych-iat-stim {
        font-family: 'Archivo', sans-serif;
        font-size: 52px !important;
        font-weight: 800;
        margin: 40px 0 !important;
        color: var(--color-primary);
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .jspsych-iat-stim img {
        max-width: 85vw !important;
        max-height: 45vh !important;
        height: auto !important;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        object-fit: cover;
      }
      
      .jspsych-content-wrapper {
        min-height: 60vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      
      /* Category labels during trials */
      .jspsych-iat-category {
        font-family: 'Archivo', sans-serif;
        font-weight: 700;
        font-size: 18px;
        padding: 12px 20px;
        border-radius: 10px;
        margin: 8px;
        box-shadow: var(--shadow-sm);
      }
      
      /* Bottom instructions during trials */
      .jspsych-display-element p {
        font-family: 'Poppins', sans-serif;
      }
      
      /* Error feedback */
      .error-feedback {
        color: var(--color-error);
        font-size: 72px;
        animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97);
      }
      
      /* Animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      /* Data display */
      #jspsych-data-display {
        background: var(--color-surface);
        padding: 24px;
        border-radius: var(--radius);
        max-width: 95%;
        margin: 20px auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        overflow-x: auto;
        box-shadow: var(--shadow-lg);
        animation: fadeIn 0.5s ease;
      }
      
      .data-header {
        font-family: 'Archivo', sans-serif;
        color: var(--color-primary);
        margin-bottom: 20px;
      }
      
      .data-summary {
        background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
      }
      
      .download-button {
        background: linear-gradient(135deg, var(--color-success) 0%, #05B187 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 700;
        border-radius: 10px;
        cursor: pointer;
        margin-bottom: 20px;
        font-family: 'Poppins', sans-serif;
        box-shadow: var(--shadow-md);
        transition: var(--transition);
      }
      
      .download-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }
      
      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        body {
          padding: 10px 5px;
          padding-bottom: 150px;
        }
        
        .instructions-header {
          padding: 24px 16px;
        }
        
        .instructions-header h1 {
          font-size: 26px;
        }
        
        .instructions-body {
          padding: 24px 16px;
        }
        
        .instructions-section h2 {
          font-size: 20px;
        }
        
        .instructions-section p, .instructions-section li {
          font-size: 15px;
        }
        
        .category-card {
          min-width: 140px;
          max-width: 200px;
          padding: 16px;
        }
        
        .category-card .category-name {
          font-size: 17px;
        }
        
        .highlight-box {
          padding: 20px 16px;
        }
        
        .highlight-box h3 {
          font-size: 18px;
        }
        
        .highlight-box p {
          font-size: 15px;
        }
        
        .touch-button {
          padding: 18px 12px;
          font-size: 15px;
        }
        
        .touch-button-key {
          font-size: 18px;
        }
        
        .touch-button-label {
          font-size: 11px;
        }
        
        .jspsych-iat-stim {
          font-size: 40px !important;
        }
        
        .jspsych-iat-stim img {
          max-width: 90vw !important;
          max-height: 40vh !important;
        }
      }
      
      @media (max-width: 480px) {
        .instructions-header h1 {
          font-size: 24px;
        }
        
        .instructions-section h2 {
          font-size: 18px;
        }
        
        .instructions-section p, .instructions-section li {
          font-size: 14px;
        }
        
        .category-card {
          min-width: 120px;
        }
        
        .category-card .category-name {
          font-size: 15px;
        }
        
        .touch-button {
          padding: 16px 10px;
          font-size: 14px;
        }
        
        .jspsych-iat-stim {
          font-size: 34px !important;
        }
      }
      
      /* Loading state */
      .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: var(--color-text-light);
      }
      
      .loading::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
      }
      
      @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
      }
    </style>
  </head>

  <body></body>

  <script>
    // Device detection
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    
    console.log('IAT Experiment Initialized');
    console.log('Device Type:', isMobile ? 'Mobile' : 'Desktop');
    console.log('Screen Size:', `${window.innerWidth}x${window.innerHeight}`);
    
    // Generate unique participant ID
    const participantId = `P${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    console.log('Participant ID:', participantId);
    
    // Touch button management
    let currentTouchButtons = null;
    
    function simulateKeyPress(key) {
      const keyCode = key === 'e' ? 69 : (key === 'i' ? 73 : 32);
      const code = key === 'e' ? 'KeyE' : (key === 'i' ? 'KeyI' : 'Space');
      
      const eventDown = new KeyboardEvent('keydown', {
        key: key,
        code: code,
        keyCode: keyCode,
        which: keyCode,
        bubbles: true,
        cancelable: true
      });
      document.dispatchEvent(eventDown);
      
      setTimeout(() => {
        const eventUp = new KeyboardEvent('keyup', {
          key: key,
          code: code,
          keyCode: keyCode,
          which: keyCode,
          bubbles: true,
          cancelable: true
        });
        document.dispatchEvent(eventUp);
      }, 50);
    }
    
    function createTouchButtons(config) {
      removeTouchButtons();
      
      const container = document.createElement('div');
      container.className = 'touch-buttons';
      container.id = 'touch-buttons';
      
      if (config.type === 'continue') {
        const btn = document.createElement('button');
        btn.className = 'touch-button center';
        btn.innerHTML = `
          <span class="touch-button-key">‚ñ∂</span>
          <span class="touch-button-label">${config.label || 'CONTINUE'}</span>
        `;
        btn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          simulateKeyPress(' ');
        };
        container.appendChild(btn);
      } else if (config.type === 'choice') {
        const leftBtn = document.createElement('button');
        leftBtn.className = 'touch-button left';
        leftBtn.innerHTML = `
          <span class="touch-button-key">‚óÄ E</span>
          <span class="touch-button-label">${config.leftLabel}</span>
        `;
        leftBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          simulateKeyPress('e');
        };
        
        const rightBtn = document.createElement('button');
        rightBtn.className = 'touch-button right';
        rightBtn.innerHTML = `
          <span class="touch-button-key">I ‚ñ∂</span>
          <span class="touch-button-label">${config.rightLabel}</span>
        `;
        rightBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          simulateKeyPress('i');
        };
        
        container.appendChild(leftBtn);
        container.appendChild(rightBtn);
      }
      
      document.body.appendChild(container);
      currentTouchButtons = container;
    }
    
    function removeTouchButtons() {
      const existing = document.getElementById('touch-buttons');
      if (existing) {
        existing.remove();
      }
      currentTouchButtons = null;
    }

    // Initialize jsPsych with enhanced data collection
    const jsPsych = initJsPsych({
      on_finish: function() {
        removeTouchButtons();
        
        // Collect all trial data
        const allData = jsPsych.data.get();
        
        // Filter IAT trials
        const iatData = allData.filter({trial_type: 'iat-image'}).union(
          allData.filter({trial_type: 'iat-html'})
        );
        
        // Calculate IAT score (D-score)
        const compatibleTrials = iatData.filter({block: 'compatible'});
        const incompatibleTrials = iatData.filter({block: 'incompatible'});
        
        const compatibleMean = compatibleTrials.select('rt').mean();
        const incompatibleMean = incompatibleTrials.select('rt').mean();
        const pooledSD = Math.sqrt(
          (compatibleTrials.select('rt').variance() + incompatibleTrials.select('rt').variance()) / 2
        );
        
        const dScore = (incompatibleMean - compatibleMean) / pooledSD;
        
        // Calculate accuracy
        const totalCorrect = iatData.filter({correct: true}).count();
        const totalTrials = iatData.count();
        const accuracy = (totalCorrect / totalTrials * 100).toFixed(1);
        
        // Prepare CSV data with enhanced metadata
        const csvData = iatData.csv();
        
        // Display results
        document.querySelector('#jspsych-data-display').innerHTML = `
          <div class="data-header">
            <h2>üéâ Experiment Complete - Thank You!</h2>
          </div>
          
          <div class="data-summary">
            <p style="margin: 8px 0;"><strong>Participant ID:</strong> ${participantId}</p>
            <p style="margin: 8px 0;"><strong>Completion Time:</strong> ${new Date().toLocaleString()}</p>
            <p style="margin: 8px 0;"><strong>Total Trials:</strong> ${totalTrials}</p>
            <p style="margin: 8px 0;"><strong>Accuracy:</strong> ${accuracy}%</p>
            <p style="margin: 8px 0;"><strong>IAT D-Score:</strong> ${dScore.toFixed(3)}</p>
            <p style="margin: 8px 0; padding-top: 12px; border-top: 2px solid #E9ECEF;"><strong>Interpretation:</strong> 
              ${Math.abs(dScore) < 0.15 ? 'Little to no automatic preference' : 
                dScore > 0 ? 'Automatic preference for Modi + Positive associations' : 
                'Automatic preference for Manmohan + Positive associations'}
            </p>
          </div>
          
          <button class="download-button" onclick="downloadData()">
            üì• Download Complete Data (CSV)
          </button>
          
          <div style="max-height: 400px; overflow-y: auto; background: #F8F9FA; padding: 16px; border-radius: 8px; border: 1px solid #DEE2E6;">
            <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 12px;">${csvData}</pre>
          </div>
        `;
        
        // Store data for download
        window.experimentData = csvData;
        
        // Log completion
        console.log('Experiment completed');
        console.log('D-Score:', dScore);
        console.log('Accuracy:', accuracy + '%');
      },
      on_data_update: function(data) {
        // Add metadata to each trial
        data.participant_id = participantId;
        data.device_type = isMobile ? 'mobile' : 'desktop';
        data.screen_width = window.innerWidth;
        data.screen_height = window.innerHeight;
        data.timestamp = new Date().toISOString();
      }
    });
    
    // Data download function
    function downloadData() {
      const blob = new Blob([window.experimentData], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `IAT_${participantId}_${Date.now()}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    }

    // Timeline
    const timeline = [];

    // ============================================
    // STIMULI CONFIGURATION
    // ============================================
    
    // Image paths - UPDATE THESE TO MATCH YOUR UPLOADED FILES
    const modi_images = [
      'modi1.jpg',
      'modi2.jpg',
      'modi3.jpg',
      'modi4.jpg'
    ];

    const manmohan_images = [
      'manmohan1.jpg',
      'manmohan2.jpg',
      'manmohan3.jpg',
      'manmohan4.jpg'
    ];

    // Word stimuli (balanced sets)
    const positive_words = [
      'Wonderful', 'Happy', 'Joy', 'Love', 'Peace', 
      'Pleasure', 'Glorious', 'Laughter', 'Success', 'Hope'
    ];

    const negative_words = [
      'Terrible', 'Awful', 'Horrible', 'Evil', 'Nasty', 
      'Failure', 'Agony', 'Pain', 'Disaster', 'Tragedy'
    ];

    // ============================================
    // WELCOME SCREEN
    // ============================================
    
    const welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="instructions-container">
          <div class="instructions-header">
            <h1>Prime Minister Popularity IAT</h1>
            <p>Measuring Implicit Attitudes Through Association</p>
          </div>
          <div class="instructions-body">
            <div class="instructions-section">
              <h2>Welcome</h2>
              <p>Thank you for participating in this research study on implicit attitudes toward Indian Prime Ministers.</p>
              <p>This task measures automatic associations between:</p>
              <ul>
                <li>Photos of <strong>Narendra Modi</strong> and <strong>Dr. Manmohan Singh</strong></li>
                <li><strong>Positive</strong> and <strong>Negative</strong> words</li>
              </ul>
            </div>
            
            <div class="highlight-box">
              <h3>‚è±Ô∏è Time Commitment</h3>
              <p>This task takes approximately <strong>5-7 minutes</strong> to complete.</p>
              <p>Please ensure you can complete it without interruption.</p>
            </div>
            
            <div class="instructions-section">
              <h2>Important Notes</h2>
              <ul>
                <li>Respond as <strong>quickly and accurately</strong> as possible</li>
                <li>There are no right or wrong answers</li>
                <li>Your data will be kept confidential</li>
              </ul>
            </div>
            
            <div style="text-align: center; margin-top: 32px;">
              <div class="cta-button">
                ${isMobile ? 'üì± Tap Below to Begin' : '‚å®Ô∏è Press Any Key to Continue'}
              </div>
            </div>
          </div>
        </div>
      `,
      on_load: function() {
        if (isMobile) {
          createTouchButtons({type: 'continue', label: 'BEGIN STUDY'});
        }
      },
      on_finish: function() {
        removeTouchButtons();
      }
    };
    timeline.push(welcome);

    // ============================================
    // INSTRUCTIONS
    // ============================================
    
    const instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="instructions-container">
          <div class="instructions-header">
            <h1>üìã Task Instructions</h1>
            <p>Please read carefully</p>
          </div>
          <div class="instructions-body">
            <div class="instructions-section">
              <h2>What You'll See</h2>
              <p>During this task, you will see:</p>
              <ul>
                <li>Photos of <strong>Narendra Modi</strong></li>
                <li>Photos of <strong>Dr. Manmohan Singh</strong></li>
                <li><strong>Positive</strong> words (e.g., "wonderful", "happy", "peace")</li>
                <li><strong>Negative</strong> words (e.g., "terrible", "awful", "pain")</li>
              </ul>
            </div>

            <div class="highlight-box">
              <h3>Your Task</h3>
              <p><strong>${isMobile ? 'Use the buttons at the bottom of the screen' : 'Use the E and I keys on your keyboard'}</strong> to categorize each item.</p>
              <p>The category labels will appear at the top of the screen.</p>
              <p><strong>Respond as quickly as possible while making as few errors as possible.</strong></p>
            </div>

            <div class="category-display">
              <div class="category-card left">
                <div class="key-label">Press ${isMobile ? 'LEFT' : 'E'}</div>
                <div class="category-name">Left Category</div>
              </div>
              <div class="category-card right">
                <div class="key-label">Press ${isMobile ? 'RIGHT' : 'I'}</div>
                <div class="category-name">Right Category</div>
              </div>
            </div>

            <div class="warning-box">
              <h3>‚ö†Ô∏è If You Make an Error</h3>
              <p>A red ‚ùå will appear. Simply press the ${isMobile ? 'other button' : 'correct key'} to continue.</p>
            </div>
            
            <div class="instructions-section">
              <h2>Important Reminders</h2>
              <ul>
                <li><strong>Speed matters:</strong> Your first instinct is what we're measuring</li>
                <li><strong>Don't overthink:</strong> Trust your automatic responses</li>
                <li><strong>Stay focused:</strong> The task requires your full attention</li>
              </ul>
            </div>
            
            <div style="text-align: center; margin-top: 32px;">
              <div class="cta-button">
                ${isMobile ? 'üëÜ Tap Below When Ready' : '‚å®Ô∏è Press SPACE When Ready'}
              </div>
            </div>
          </div>
        </div>
      `,
      choices: [' '],
      on_load: function() {
        if (isMobile) {
          createTouchButtons({type: 'continue', label: 'START PRACTICE'});
        }
      },
      on_finish: function() {
        removeTouchButtons();
      }
    };
    timeline.push(instructions);

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function createBlockInstructions(title, description, leftLabel, rightLabel, buttonLabel, isReversed = false) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="instructions-container">
            <div class="instructions-header" style="${isReversed ? 'background: linear-gradient(135deg, #FF6B9D 0%, #EF476F 100%);' : ''}">
              <h1>${isReversed ? '‚ö†Ô∏è ' : ''}${title}</h1>
              <p>${description}</p>
            </div>
            <div class="instructions-body">
              ${isReversed ? `
                <div class="warning-box">
                  <h3>‚ö†Ô∏è IMPORTANT: Categories Have Switched!</h3>
                  <p>Pay close attention to the new category positions below.</p>
                </div>
              ` : ''}
              
              <div class="category-display">
                <div class="category-card left">
                  <div class="key-label">Press ${isMobile ? 'LEFT' : 'E'}</div>
                  <div class="category-name">${leftLabel}</div>
                </div>
                <div class="category-card right">
                  <div class="key-label">Press ${isMobile ? 'RIGHT' : 'I'}</div>
                  <div class="category-name">${rightLabel}</div>
                </div>
              </div>
              
              <div style="text-align: center; margin-top: 32px;">
                <div class="cta-button">
                  ${isMobile ? 'üëÜ Tap Below to Start' : '‚å®Ô∏è Press SPACE to Start'}
                </div>
              </div>
            </div>
          </div>
        `,
        choices: [' '],
        on_load: function() {
          if (isMobile) {
            createTouchButtons({type: 'continue', label: buttonLabel});
          }
        },
        on_finish: function() {
          removeTouchButtons();
        }
      };
    }

    function createImageTrial(block, leftCat, rightCat, leftShort, rightShort, critical = false) {
      return {
        type: jsPsychIatImage,
        stimulus: jsPsych.timelineVariable('stimulus'),
        stim_key_association: jsPsych.timelineVariable('stim_key_association'),
        html_when_wrong: '<span class="error-feedback">‚ùå</span>',
        bottom_instructions: `<p style="font-size: 16px; font-weight: 600; color: var(--color-text-light);">${isMobile ? 'LEFT' : 'E'} = ${leftCat} | ${isMobile ? 'RIGHT' : 'I'} = ${rightCat}</p>`,
        force_correct_key_press: true,
        display_feedback: true,
        trial_duration: 3000,
        left_category_key: 'e',
        right_category_key: 'i',
        left_category_label: leftCat.split('/'),
        right_category_label: rightCat.split('/'),
        response_ends_trial: true,
        stimulus_width: 400,
        data: {
          block: block,
          item_type: 'image',
          critical_trial: critical,
          stimulus_name: jsPsych.timelineVariable('stimulus')
        },
        on_load: function() {
          if (isMobile) {
            createTouchButtons({
              type: 'choice',
              leftLabel: leftShort,
              rightLabel: rightShort
            });
          }
        }
      };
    }

    function createWordTrial(block, leftCat, rightCat, leftShort, rightShort, critical = false) {
      return {
        type: jsPsychIatHtml,
        stimulus: jsPsych.timelineVariable('stimulus'),
        stim_key_association: jsPsych.timelineVariable('stim_key_association'),
        html_when_wrong: '<span class="error-feedback">‚ùå</span>',
        bottom_instructions: `<p style="font-size: 16px; font-weight: 600; color: var(--color-text-light);">${isMobile ? 'LEFT' : 'E'} = ${leftCat} | ${isMobile ? 'RIGHT' : 'I'} = ${rightCat}</p>`,
        force_correct_key_press: true,
        display_feedback: true,
        trial_duration: 3000,
        left_category_key: 'e',
        right_category_key: 'i',
        left_category_label: leftCat.split('/'),
        right_category_label: rightCat.split('/'),
        response_ends_trial: true,
        data: {
          block: block,
          item_type: 'word',
          critical_trial: critical,
          stimulus_word: jsPsych.timelineVariable('stimulus')
        },
        on_load: function() {
          if (isMobile) {
            createTouchButtons({
              type: 'choice',
              leftLabel: leftShort,
              rightLabel: rightShort
            });
          }
        }
      };
    }

    // ============================================
    // BLOCK 1: PM PRACTICE (20 trials)
    // ============================================
    
    timeline.push(createBlockInstructions(
      'Practice Block 1',
      'Categorize Prime Ministers',
      'Narendra Modi',
      'Dr. Manmohan Singh',
      'START PRACTICE'
    ));
    
    timeline.push({
      timeline: [createImageTrial('pm_practice', 'Modi', 'Manmohan', 'Modi', 'Manmohan')],
      timeline_variables: [
        ...modi_images.map(img => ({stimulus: img, stim_key_association: 'left'})),
        ...manmohan_images.map(img => ({stimulus: img, stim_key_association: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    });

    // ============================================
    // BLOCK 2: WORD PRACTICE (20 trials)
    // ============================================
    
    timeline.push(createBlockInstructions(
      'Practice Block 2',
      'Categorize Words',
      'Positive Words',
      'Negative Words',
      'START PRACTICE'
    ));
    
    timeline.push({
      timeline: [createWordTrial('word_practice', 'Positive', 'Negative', 'Positive', 'Negative')],
      timeline_variables: [
        ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
        ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
      ],
      randomize_order: true,
      repetitions: 1
    });

    // ============================================
    // BLOCK 3: COMBINED PRACTICE (20 trials)
    // Modi + Positive / Manmohan + Negative
    // ============================================
    
    timeline.push(createBlockInstructions(
      'Practice Block 3',
      'Combined Categories',
      'Modi OR Positive',
      'Manmohan OR Negative',
      'START COMBINED'
    ));
    
    timeline.push({
      timeline: [
        {
          timeline: [createImageTrial('combined1_practice', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'left'})),
            ...manmohan_images.map(img => ({stimulus: img, stim_key_association: 'right'}))
          ],
          randomize_order: true
        },
        {
          timeline: [createWordTrial('combined1_practice', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true
        }
      ],
      randomize_order: true,
      repetitions: 1
    });

    // ============================================
    // BLOCK 4: CRITICAL COMPATIBLE TEST (40 trials)
    // Modi + Positive / Manmohan + Negative
    // ============================================
    
    timeline.push({
      timeline: [
        {
          timeline: [createImageTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'left'})),
            ...manmohan_images.map(img => ({stimulus: img, stim_key_association: 'right'}))
          ],
          randomize_order: true,
          repetitions: 2
        },
        {
          timeline: [createWordTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true,
          repetitions: 2
        }
      ],
      randomize_order: true
    });

    // ============================================
    // BLOCK 5: REVERSED PM PRACTICE (40 trials)
    // ============================================
    
    timeline.push(createBlockInstructions(
      'Practice Block 4',
      'Categories have switched - pay attention!',
      'Dr. Manmohan Singh',
      'Narendra Modi',
      'START REVERSED',
      true
    ));
    
    timeline.push({
      timeline: [createImageTrial('pm_reversed', 'Manmohan', 'Modi', 'Manmohan', 'Modi')],
      timeline_variables: [
        ...modi_images.map(img => ({stimulus: img, stim_key_association: 'right'})),
        ...manmohan_images.map(img => ({stimulus: img, stim_key_association: 'left'}))
      ],
      randomize_order: true,
      repetitions: 5
    });

    // ============================================
    // BLOCK 6: COMBINED REVERSED PRACTICE (20 trials)
    // Manmohan + Positive / Modi + Negative
    // ============================================
    
    timeline.push(createBlockInstructions(
      'Practice Block 5',
      'Combined Categories - Reversed',
      'Manmohan OR Positive',
      'Modi OR Negative',
      'START COMBINED'
    ));
    
    timeline.push({
      timeline: [
        {
          timeline: [createImageTrial('combined2_practice', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'right'})),
            ...manmohan_images.map(img => ({stimulus: img, stim_key_association: 'left'}))
          ],
          randomize_order: true
        },
        {
          timeline: [createWordTrial('combined2_practice', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true
        }
      ],
      randomize_order: true,
      repetitions: 1
    });

    // ============================================
    // BLOCK 7: CRITICAL INCOMPATIBLE TEST (40 trials)
    // Manmohan + Positive / Modi + Negative
    // ============================================
    
    timeline.push({
      timeline: [
        {
          timeline: [createImageTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'right'})),
            ...manmohan_images.map(img => ({stimulus: img, stim_key_association: 'left'}))
          ],
          randomize_order: true,
          repetitions: 2
        },
        {
          timeline: [createWordTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true,
          repetitions: 2
        }
      ],
      randomize_order: true
    });

    // ============================================
    // DEBRIEF
    // ============================================
    
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="instructions-container">
          <div class="instructions-header" style="background: linear-gradient(135deg, #06D6A0 0%, #05B187 100%);">
            <h1>üéâ Thank You for Participating!</h1>
            <p>The experiment is now complete</p>
          </div>
          <div class="instructions-body">
            <div class="instructions-section">
              <h2>About This Study</h2>
              <p>This was an Implicit Association Test (IAT) designed to measure automatic associations between:</p>
              <ul>
                <li>Narendra Modi and Dr. Manmohan Singh</li>
                <li>Positive and negative concepts</li>
              </ul>
              <p>The IAT works by measuring how quickly you can pair concepts together. Faster responses indicate stronger automatic associations.</p>
            </div>
            
            <div class="highlight-box">
              <h3>Understanding Your Results</h3>
              <p>The D-score is a standardized measure:</p>
              <p><strong>Positive scores:</strong> Stronger automatic association between Modi and positive words</p>
              <p><strong>Negative scores:</strong> Stronger automatic association between Manmohan and positive words</p>
              <p><strong>Scores near 0:</strong> Little to no automatic preference</p>
            </div>
            
            <div class="instructions-section">
              <h2>Important Note</h2>
              <p>IAT scores reflect <strong>automatic associations</strong>, which may differ from your conscious beliefs and values. These associations can be influenced by exposure, media coverage, and cultural context.</p>
            </div>
            
            <div style="text-align: center; margin-top: 32px;">
              <div class="cta-button">
                ${isMobile ? 'üëÜ Tap to View Results' : '‚å®Ô∏è Press Any Key to View Results'}
              </div>
            </div>
          </div>
        </div>
      `,
      on_load: function() {
        if (isMobile) {
          createTouchButtons({type: 'continue', label: 'VIEW RESULTS'});
        }
      },
      on_finish: function() {
        removeTouchButtons();
      }
    });

    // ============================================
    // RUN EXPERIMENT
    // ============================================
    
    jsPsych.run(timeline);
  </script>
</html>
