<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>IAT Study</title>

  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
  
  <!-- FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      background: #1a1a2e;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      position: fixed;
    }
    
    /* FORCE LANDSCAPE */
    @media screen and (orientation: portrait) {
      body::before {
        content: "‚Üª";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a1a2e;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 80px;
        z-index: 999999;
        flex-direction: column;
      }
      
      body::after {
        content: "Please rotate your device to landscape mode";
        position: fixed;
        top: 60%;
        left: 0;
        width: 100%;
        text-align: center;
        color: white;
        font-size: 18px;
        z-index: 999999;
      }
      
      #experiment, #controls {
        display: none !important;
      }
    }
    
    @media screen and (orientation: landscape) {
      body {
        padding-bottom: 25vh;
      }
    }
    
    .container {
      max-width: 90vw;
      margin: 0 auto;
      padding: 3vh 4vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .box {
      background: white;
      border-radius: 12px;
      padding: 3vh 4vw;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 900px;
    }
    
    h1 {
      font-size: 3.5vh;
      margin-bottom: 2vh;
      color: #222;
    }
    
    p {
      font-size: 2vh;
      line-height: 1.4;
      color: #555;
      margin-bottom: 1.5vh;
    }
    
    .cats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2vw;
      margin: 2vh 0;
    }
    
    .cat {
      background: #2c3e50;
      color: white;
      padding: 2vh 2vw;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 2.5vh;
    }
    
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 2vh;
      margin: 2vh 0;
      border-radius: 4px;
      font-size: 2vh;
    }
    
    .success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 2vh;
      margin: 2vh 0;
      border-radius: 4px;
      font-size: 2vh;
    }
    
    .btn {
      width: 100%;
      padding: 2vh;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 2.5vh;
      font-weight: 600;
      cursor: pointer;
      margin: 1vh 0;
    }
    
    .btn:active {
      background: #34495e;
      transform: scale(0.98);
    }
    
    /* MOBILE CONTROLS */
    #controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 25vh;
      background: linear-gradient(to top, #16213e 0%, #1a1a2e 100%);
      display: none;
      gap: 2vw;
      padding: 2vh 3vw;
      z-index: 999999;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.5);
    }
    
    #controls.active {
      display: flex !important;
    }
    
    .control-btn {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 4vh;
      font-weight: 900;
      cursor: pointer;
      position: relative;
      box-shadow: 0 8px 0 #5a3d8a, 0 10px 30px rgba(0,0,0,0.4);
      transition: all 0.1s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .control-btn:active {
      transform: translateY(8px);
      box-shadow: 0 0 0 #5a3d8a, 0 2px 10px rgba(0,0,0,0.4);
    }
    
    .control-btn.single {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 8px 0 #c74658, 0 10px 30px rgba(0,0,0,0.4);
    }
    
    .control-btn.single:active {
      box-shadow: 0 0 0 #c74658, 0 2px 10px rgba(0,0,0,0.4);
    }
    
    .key-text {
      font-size: 6vh;
      margin-bottom: 1vh;
    }
    
    .key-label {
      font-size: 2vh;
      opacity: 0.9;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    /* TRIAL DISPLAY */
    .jspsych-iat-stim {
      font-size: 6vh !important;
      font-weight: 700 !important;
      color: #222 !important;
      margin: 5vh auto !important;
      text-align: center !important;
      padding: 0 3vw !important;
    }
    
    .jspsych-iat-stim img {
      max-width: 50vw !important;
      max-height: 40vh !important;
      border-radius: 10px;
      display: block !important;
      margin: 0 auto !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .error-mark {
      color: #e74c3c !important;
      font-size: 10vh !important;
      font-weight: 900 !important;
    }
    
    .jspsych-iat-category {
      font-weight: 700 !important;
      font-size: 2.5vh !important;
      padding: 1.5vh 3vw !important;
      border: 3px solid #2c3e50 !important;
      border-radius: 8px !important;
      margin: 1vh !important;
      background: white !important;
    }
    
    .jspsych-display-element > p {
      font-size: 2.5vh !important;
      color: #fff !important;
      background: rgba(0,0,0,0.7) !important;
      margin-top: 3vh !important;
      padding: 2vh 3vw 28vh !important;
      text-align: center !important;
      font-weight: 600 !important;
    }
    
    .result-item {
      padding: 1.5vh 0;
      border-bottom: 1px solid #eee;
      font-size: 2vh;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body>
  <div id="experiment"></div>
  <div id="controls"></div>
</body>

<script>
// ===========================================
// GLOBAL VARIABLES
// ===========================================
const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 768;
const PID = 'P' + Date.now();
let EXPERIMENT_DATA = null;

console.log('=== IAT STARTED ===');
console.log('Mobile:', IS_MOBILE);
console.log('Participant:', PID);

// ===========================================
// STIMULI
// ===========================================
const IMG_MODI = ['imagesmodi1.jpg.jpeg', 'imagesmodi2.jpg.jpeg', 'imagesmodi3.jpg.jpeg', 'imagesmodi4.jpg.jpeg'];
const IMG_MANMOHAN = ['imagesprevious1.jpg.jpeg', 'imagesprevious2.jpg.jpeg', 'imagesprevious3.jpg.jpeg', 'imagesprevious4.jpg.jpeg'];
const WORDS_POS = ['Wonderful', 'Happy', 'Joy', 'Love', 'Peace', 'Pleasure', 'Glorious', 'Laughter', 'Success', 'Hope'];
const WORDS_NEG = ['Terrible', 'Awful', 'Horrible', 'Evil', 'Nasty', 'Failure', 'Agony', 'Pain', 'Disaster', 'Tragedy'];

// ===========================================
// KEY PRESS FUNCTION - DIRECT METHOD
// ===========================================
window.doKeyPress = function(key) {
  console.log('üîë KEY PRESSED:', key);
  
  const codes = {
    'e': {key: 'e', code: 'KeyE', keyCode: 69},
    'i': {key: 'i', code: 'KeyI', keyCode: 73},
    ' ': {key: ' ', code: 'Space', keyCode: 32}
  };
  
  const info = codes[key];
  
  // Create events
  const down = new KeyboardEvent('keydown', {
    key: info.key,
    code: info.code,
    keyCode: info.keyCode,
    which: info.keyCode,
    bubbles: true,
    cancelable: true
  });
  
  const up = new KeyboardEvent('keyup', {
    key: info.key,
    code: info.code,
    keyCode: info.keyCode,
    which: info.keyCode,
    bubbles: true,
    cancelable: true
  });
  
  // Dispatch to all possible targets
  document.dispatchEvent(down);
  setTimeout(() => document.dispatchEvent(up), 50);
}

// ===========================================
// CONTROL SETUP
// ===========================================
window.setupControls = function(mode, labels) {
  console.log('üéÆ SETUP CONTROLS:', mode, labels);
  
  if (!IS_MOBILE) return;
  
  const ctrl = document.getElementById('controls');
  ctrl.innerHTML = '';
  ctrl.className = 'active';
  
  if (mode === 'single') {
    ctrl.innerHTML = `
      <button class="control-btn single" onclick="doKeyPress(' ')">
        <div class="key-text">TAP</div>
        <div class="key-label">${labels}</div>
      </button>
    `;
  } else {
    ctrl.innerHTML = `
      <button class="control-btn" onclick="doKeyPress('e')">
        <div class="key-text">E</div>
        <div class="key-label">${labels.e}</div>
      </button>
      <button class="control-btn" onclick="doKeyPress('i')">
        <div class="key-text">I</div>
        <div class="key-label">${labels.i}</div>
      </button>
    `;
  }
}

window.hideControls = function() {
  console.log('üö´ HIDE CONTROLS');
  const ctrl = document.getElementById('controls');
  if (ctrl) ctrl.className = '';
}

// ===========================================
// DOWNLOAD FUNCTIONS
// ===========================================
window.downloadCSV = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  const blob = new Blob([EXPERIMENT_DATA.csv], {type: 'text/csv;charset=utf-8'});
  saveAs(blob, `IAT_${PID}.csv`);
  alert('‚úÖ CSV downloaded! Send this file to the researcher.');
}

window.downloadSummary = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  const summary = `IAT EXPERIMENT RESULTS
=======================

Participant ID: ${EXPERIMENT_DATA.id}
Date & Time: ${EXPERIMENT_DATA.date}
Device: ${EXPERIMENT_DATA.device}

PERFORMANCE:
Total Trials: ${EXPERIMENT_DATA.trials}
Accuracy: ${EXPERIMENT_DATA.accuracy}
Mean RT: ${EXPERIMENT_DATA.rt}

RESULTS:
D-Score: ${EXPERIMENT_DATA.dscore}
Interpretation: ${EXPERIMENT_DATA.result}

${EXPERIMENT_DATA.explanation}
`;
  const blob = new Blob([summary], {type: 'text/plain;charset=utf-8'});
  saveAs(blob, `IAT_Summary_${PID}.txt`);
  alert('‚úÖ Summary downloaded!');
}

window.downloadBoth = function() {
  downloadCSV();
  setTimeout(() => downloadSummary(), 500);
}

// ===========================================
// JSPSYCH
// ===========================================
const jsPsych = initJsPsych({
  display_element: 'experiment',
  
  on_finish: function() {
    hideControls();
    console.log('üìä PROCESSING DATA');
    
    const allData = jsPsych.data.get();
    const iatData = allData.filter([
      {trial_type: 'iat-image'},
      {trial_type: 'iat-html'}
    ]);
    
    const compatible = iatData.filter({block: 'compatible', critical: true});
    const incompatible = iatData.filter({block: 'incompatible', critical: true});
    
    const meanComp = compatible.select('rt').mean();
    const meanIncomp = incompatible.select('rt').mean();
    const sdComp = compatible.select('rt').sd();
    const sdIncomp = incompatible.select('rt').sd();
    const pooledSD = Math.sqrt((sdComp * sdComp + sdIncomp * sdIncomp) / 2);
    const dScore = (meanIncomp - meanComp) / pooledSD;
    
    const correct = iatData.filter({correct: true}).count();
    const total = iatData.count();
    const accuracy = ((correct / total) * 100).toFixed(1);
    const meanRT = iatData.select('rt').mean().toFixed(0);
    
    let interpretation = '';
    let explanation = '';
    
    if (Math.abs(dScore) < 0.15) {
      interpretation = 'No clear preference';
      explanation = 'Response times were similar for both pairings.';
    } else if (dScore > 0.65) {
      interpretation = 'Strong Modi-Positive association';
      explanation = 'Much faster when Modi paired with positive words.';
    } else if (dScore > 0.35) {
      interpretation = 'Moderate Modi-Positive association';
      explanation = 'Noticeably faster when Modi paired with positive words.';
    } else if (dScore > 0) {
      interpretation = 'Slight Modi-Positive association';
      explanation = 'Somewhat faster when Modi paired with positive words.';
    } else if (dScore < -0.65) {
      interpretation = 'Strong Manmohan-Positive association';
      explanation = 'Much faster when Manmohan paired with positive words.';
    } else if (dScore < -0.35) {
      interpretation = 'Moderate Manmohan-Positive association';
      explanation = 'Noticeably faster when Manmohan paired with positive words.';
    } else {
      interpretation = 'Slight Manmohan-Positive association';
      explanation = 'Somewhat faster when Manmohan paired with positive words.';
    }
    
    const csv = iatData.csv();
    
    EXPERIMENT_DATA = {
      id: PID,
      date: new Date().toLocaleString(),
      device: IS_MOBILE ? 'Mobile' : 'Desktop',
      trials: total,
      accuracy: accuracy + '%',
      rt: meanRT + 'ms',
      dscore: dScore.toFixed(3),
      result: interpretation,
      explanation: explanation,
      csv: csv
    };
    
    console.log('‚úÖ DATA READY');
    showResults();
  },
  
  on_data_update: function(data) {
    data.participant_id = PID;
    data.device = IS_MOBILE ? 'mobile' : 'desktop';
    data.timestamp = new Date().toISOString();
  }
});

function showResults() {
  document.getElementById('experiment').innerHTML = `
    <div class="container">
      <div class="box">
        <h1>‚úÖ Experiment Complete!</h1>
        <p>Thank you for participating.</p>
        
        <div class="success">
          <strong>Your data is ready to download.</strong>
        </div>
        
        <div style="background: #f8f9fa; padding: 2vh; border-radius: 8px; margin: 2vh 0;">
          <div class="result-item"><strong>ID:</strong> ${EXPERIMENT_DATA.id}</div>
          <div class="result-item"><strong>Date:</strong> ${EXPERIMENT_DATA.date}</div>
          <div class="result-item"><strong>Device:</strong> ${EXPERIMENT_DATA.device}</div>
          <div class="result-item"><strong>Trials:</strong> ${EXPERIMENT_DATA.trials}</div>
          <div class="result-item"><strong>Accuracy:</strong> ${EXPERIMENT_DATA.accuracy}</div>
          <div class="result-item"><strong>Avg RT:</strong> ${EXPERIMENT_DATA.rt}</div>
          <div class="result-item" style="margin-top: 2vh; padding-top: 2vh; border-top: 2px solid #ddd;">
            <strong>D-Score:</strong> ${EXPERIMENT_DATA.dscore}
          </div>
          <div class="result-item"><strong>Result:</strong> ${EXPERIMENT_DATA.result}</div>
          <div style="margin-top: 2vh; padding: 2vh; background: white; border-radius: 6px;">
            ${EXPERIMENT_DATA.explanation}
          </div>
        </div>
        
        <div class="warning">
          <strong>‚ö†Ô∏è IMPORTANT:</strong> Download and send your data to the researcher!
        </div>
        
        <button class="btn" onclick="downloadBoth()">üì• Download All Data</button>
        <button class="btn" onclick="downloadCSV()">üìä Download CSV</button>
        <button class="btn" onclick="downloadSummary()">üìÑ Download Summary</button>
      </div>
    </div>
  `;
}

// ===========================================
// TIMELINE
// ===========================================
const timeline = [];

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Implicit Association Test</h1>
        <p><strong>Political Attitudes Study</strong></p>
        <p>Measures automatic associations between political figures and positive/negative words.</p>
        
        <div style="margin: 2vh 0; padding: 2vh; background: #f8f9fa; border-radius: 8px;">
          <p><strong>You will see:</strong></p>
          <p>‚Ä¢ Photos of Narendra Modi<br>
          ‚Ä¢ Photos of Dr. Manmohan Singh<br>
          ‚Ä¢ Positive words<br>
          ‚Ä¢ Negative words</p>
        </div>
        
        <div class="warning">
          <strong>Duration:</strong> 5-7 minutes<br>
          <strong>${IS_MOBILE ? 'Keep device in LANDSCAPE mode!' : 'Respond as fast as possible!'}</strong>
        </div>
        
        <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
          ${IS_MOBILE ? 'üëá TAP CONTINUE BELOW üëá' : 'PRESS ANY KEY'}
        </p>
      </div>
    </div>
  `,
  on_load: function() {
    if (IS_MOBILE) setupControls('single', 'CONTINUE');
  },
  on_finish: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Instructions</h1>
        <p>Use ${IS_MOBILE ? '<strong>the E and I buttons below</strong>' : '<strong>E and I keys</strong>'} to categorize items.</p>
        
        <div class="cats">
          <div class="cat">E = Left</div>
          <div class="cat">I = Right</div>
        </div>
        
        <div class="warning">
          <strong>If wrong:</strong> An ‚úï appears. Press ${IS_MOBILE ? 'the other button' : 'the correct key'}.
        </div>
        
        <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
          ${IS_MOBILE ? 'üëá TAP BEGIN BELOW üëá' : 'PRESS SPACE'}
        </p>
      </div>
    </div>
  `,
  choices: [' '],
  on_load: function() {
    if (IS_MOBILE) setupControls('single', 'BEGIN');
  },
  on_finish: function() {
    hideControls();
  }
});

function blockIntro(title, left, right, reversed) {
  return {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div class="container">
        <div class="box">
          <h1>${title}</h1>
          ${reversed ? '<div class="warning"><strong>‚ö†Ô∏è SIDES SWITCHED!</strong></div>' : ''}
          <div class="cats">
            <div class="cat">E = ${left}</div>
            <div class="cat">I = ${right}</div>
          </div>
          <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
            ${IS_MOBILE ? 'üëá TAP START üëá' : 'PRESS SPACE'}
          </p>
        </div>
      </div>
    `,
    choices: [' '],
    on_load: function() {
      if (IS_MOBILE) setupControls('single', 'START');
    },
    on_finish: function() {
      hideControls();
    }
  };
}

function imgTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatImage,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'image', critical: crit || false},
    on_load: function() {
      if (IS_MOBILE) setupControls('double', {e: lShort, i: rShort});
    }
  };
}

function wordTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatHtml,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'word', critical: crit || false},
    on_load: function() {
      if (IS_MOBILE) setupControls('double', {e: lShort, i: rShort});
    }
  };
}

// BLOCK 1
timeline.push(blockIntro('Categorize Leaders', 'Modi', 'Manmohan', false));
timeline.push({
  timeline: [imgTrial('practice1', 'Modi', 'Manmohan', 'Modi', 'Manmohan')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 2
});

// BLOCK 2
timeline.push(blockIntro('Categorize Words', 'Positive', 'Negative', false));
timeline.push({
  timeline: [wordTrial('practice2', 'Positive', 'Negative', 'Positive', 'Negative')],
  timeline_variables: [
    ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
    ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 3
timeline.push(blockIntro('Combined', 'Modi or Positive', 'Manmohan or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 4 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// BLOCK 5
timeline.push(blockIntro('Categorize Leaders', 'Manmohan', 'Modi', true));
timeline.push({
  timeline: [imgTrial('practice4', 'Manmohan', 'Modi', 'Manmohan', 'Modi')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
  ],
  randomize_order: true,
  repetitions: 5
});

// BLOCK 6
timeline.push(blockIntro('Combined', 'Manmohan or Positive', 'Modi or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 7 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Almost Done!</h1>
        <p>You completed all trials.</p>
        <div class="success">
          The IAT measures automatic associations by comparing response times.
        </div>
        <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
          ${IS_MOBILE ? 'üëá TAP FOR RESULTS üëá' : 'PRESS ANY KEY'}
        </p>
      </div>
    </div>
  `,
  on_load: function() {
    if (IS_MOBILE) setupControls('single', 'VIEW RESULTS');
  },
  on_finish: function() {
    hideControls();
  }
});

console.log('üöÄ STARTING EXPERIMENT');
jsPsych.run(timeline);
</script>
</html>
