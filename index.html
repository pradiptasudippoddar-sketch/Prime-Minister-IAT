<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>IAT Study - Political Attitudes</title>

  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
  
  <!-- FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      background: #1a1a2e;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      position: fixed;
    }
    
    /* FORCE LANDSCAPE */
    @media screen and (orientation: portrait) {
      body::before {
        content: "‚Üª";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a1a2e;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 80px;
        z-index: 999999;
        flex-direction: column;
      }
      
      body::after {
        content: "Please rotate your device to landscape mode";
        position: fixed;
        top: 60%;
        left: 0;
        width: 100%;
        text-align: center;
        color: white;
        font-size: 18px;
        z-index: 999999;
      }
      
      #experiment, #controls {
        display: none !important;
      }
    }
    
    @media screen and (orientation: landscape) {
      body {
        padding-bottom: 25vh;
      }
    }
    
    .container {
      max-width: 90vw;
      margin: 0 auto;
      padding: 3vh 4vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }
    
    .box {
      background: white;
      border-radius: 12px;
      padding: 3vh 4vw;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    h1 {
      font-size: 3.5vh;
      margin-bottom: 2vh;
      color: #222;
    }
    
    h2 {
      font-size: 2.5vh;
      margin: 2vh 0 1vh 0;
      color: #444;
    }
    
    p {
      font-size: 2vh;
      line-height: 1.4;
      color: #555;
      margin-bottom: 1.5vh;
    }
    
    .cats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2vw;
      margin: 2vh 0;
    }
    
    .cat {
      background: #2c3e50;
      color: white;
      padding: 2vh 2vw;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 2.5vh;
    }
    
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 2vh;
      margin: 2vh 0;
      border-radius: 4px;
      font-size: 2vh;
    }
    
    .success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 2vh;
      margin: 2vh 0;
      border-radius: 4px;
      font-size: 2vh;
    }
    
    .info {
      background: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 2vh;
      margin: 2vh 0;
      border-radius: 4px;
      font-size: 2vh;
    }
    
    .btn {
      width: 100%;
      padding: 2vh;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 2.5vh;
      font-weight: 600;
      cursor: pointer;
      margin: 1vh 0;
    }
    
    .btn:active {
      background: #34495e;
      transform: scale(0.98);
    }
    
    /* MOBILE CONTROLS */
    #controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 25vh;
      background: linear-gradient(to top, #16213e 0%, #1a1a2e 100%);
      display: none;
      gap: 2vw;
      padding: 2vh 3vw;
      z-index: 999999;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.5);
    }
    
    #controls.active {
      display: flex !important;
    }
    
    .control-btn {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 4vh;
      font-weight: 900;
      cursor: pointer;
      position: relative;
      box-shadow: 0 8px 0 #5a3d8a, 0 10px 30px rgba(0,0,0,0.4);
      transition: all 0.1s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .control-btn:active {
      transform: translateY(8px);
      box-shadow: 0 0 0 #5a3d8a, 0 2px 10px rgba(0,0,0,0.4);
    }
    
    .control-btn.single {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 8px 0 #c74658, 0 10px 30px rgba(0,0,0,0.4);
    }
    
    .control-btn.single:active {
      box-shadow: 0 0 0 #c74658, 0 2px 10px rgba(0,0,0,0.4);
    }
    
    .key-text {
      font-size: 6vh;
      margin-bottom: 1vh;
    }
    
    .key-label {
      font-size: 2vh;
      opacity: 0.9;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    /* SURVEY STYLES */
    .jspsych-survey-multi-choice-question,
    .jspsych-survey-likert-question,
    .jspsych-content {
      user-select: text !important;
      -webkit-user-select: text !important;
    }
    
    .jspsych-survey-multi-choice-text,
    .jspsych-survey-likert-text {
      font-size: 2.2vh !important;
      color: #333 !important;
      margin-bottom: 1.5vh !important;
      font-weight: 600 !important;
    }
    
    .jspsych-survey-multi-choice-option,
    .jspsych-survey-likert-opts {
      font-size: 2vh !important;
      margin: 1vh 0 !important;
    }
    
    input[type="radio"] {
      width: 20px !important;
      height: 20px !important;
      margin-right: 10px !important;
      cursor: pointer !important;
    }
    
    label {
      cursor: pointer !important;
      user-select: none !important;
      -webkit-user-select: none !important;
    }
    
    input[type="text"],
    input[type="number"] {
      font-size: 2vh !important;
      padding: 1vh !important;
      border: 2px solid #ddd !important;
      border-radius: 4px !important;
      width: 100% !important;
      max-width: 200px !important;
      user-select: text !important;
      -webkit-user-select: text !important;
    }
    
    #jspsych-survey-html-form-next,
    #jspsych-survey-multi-choice-next,
    #jspsych-survey-likert-next {
      background: #2c3e50 !important;
      color: white !important;
      border: none !important;
      padding: 2vh 4vw !important;
      font-size: 2.5vh !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      cursor: pointer !important;
      margin-top: 3vh !important;
    }
    
    /* TRIAL DISPLAY */
    .jspsych-iat-stim {
      font-size: 6vh !important;
      font-weight: 700 !important;
      color: #222 !important;
      margin: 5vh auto !important;
      text-align: center !important;
      padding: 0 3vw !important;
    }
    
    .jspsych-iat-stim img {
      max-width: 50vw !important;
      max-height: 40vh !important;
      border-radius: 10px;
      display: block !important;
      margin: 0 auto !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .error-mark {
      color: #e74c3c !important;
      font-size: 10vh !important;
      font-weight: 900 !important;
    }
    
    .jspsych-iat-category {
      font-weight: 700 !important;
      font-size: 2.5vh !important;
      padding: 1.5vh 3vw !important;
      border: 3px solid #2c3e50 !important;
      border-radius: 8px !important;
      margin: 1vh !important;
      background: white !important;
    }
    
    .jspsych-display-element > p {
      font-size: 2.5vh !important;
      color: #fff !important;
      background: rgba(0,0,0,0.7) !important;
      margin-top: 3vh !important;
      padding: 2vh 3vw 28vh !important;
      text-align: center !important;
      font-weight: 600 !important;
    }
    
    .result-item {
      padding: 1.5vh 0;
      border-bottom: 1px solid #eee;
      font-size: 2vh;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body>
  <div id="experiment"></div>
  <div id="controls"></div>
</body>

<script>
// ===========================================
// GLOBAL VARIABLES
// ===========================================
const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 768;
const PID = 'P' + Date.now();
let EXPERIMENT_DATA = null;
let DEMOGRAPHIC_DATA = {};
let POST_TEST_DATA = {};

console.log('=== IAT STARTED ===');
console.log('Mobile:', IS_MOBILE);
console.log('Participant:', PID);

// ===========================================
// STIMULI - UPDATED WORDS
// ===========================================
const IMG_MODI = ['imagesmodi1.jpg.jpeg', 'imagesmodi2.jpg.jpeg', 'imagesmodi3.jpg.jpeg', 'imagesmodi4.jpg.jpeg'];
const IMG_MANMOHAN = ['imagesprevious1.jpg.jpeg', 'imagesprevious2.jpg.jpeg', 'imagesprevious3.jpg.jpeg', 'imagesprevious4.jpg.jpeg'];
const WORDS_POS = ['Lovely', 'Joyous', 'Pleasing', 'Glorious', 'Delightful', 'Beautiful', 'Enjoy', 'Spectacular'];
const WORDS_NEG = ['Pain', 'Yucky', 'Failure', 'Disgust', 'Humiliate', 'Tragic', 'Rotten', 'Annoy'];

// ===========================================
// KEY PRESS FUNCTION
// ===========================================
window.doKeyPress = function(key) {
  console.log('üîë KEY PRESSED:', key);
  
  const codes = {
    'e': {key: 'e', code: 'KeyE', keyCode: 69},
    'i': {key: 'i', code: 'KeyI', keyCode: 73},
    ' ': {key: ' ', code: 'Space', keyCode: 32}
  };
  
  const info = codes[key];
  
  const down = new KeyboardEvent('keydown', {
    key: info.key,
    code: info.code,
    keyCode: info.keyCode,
    which: info.keyCode,
    bubbles: true,
    cancelable: true
  });
  
  const up = new KeyboardEvent('keyup', {
    key: info.key,
    code: info.code,
    keyCode: info.keyCode,
    which: info.keyCode,
    bubbles: true,
    cancelable: true
  });
  
  document.dispatchEvent(down);
  setTimeout(() => document.dispatchEvent(up), 50);
}

// ===========================================
// CONTROL SETUP
// ===========================================
window.setupControls = function(mode, labels) {
  console.log('üéÆ SETUP CONTROLS:', mode, labels);
  
  if (!IS_MOBILE) return;
  
  const ctrl = document.getElementById('controls');
  ctrl.innerHTML = '';
  ctrl.className = 'active';
  
  if (mode === 'single') {
    ctrl.innerHTML = `
      <button class="control-btn single" onclick="doKeyPress(' ')">
        <div class="key-text">TAP</div>
        <div class="key-label">${labels}</div>
      </button>
    `;
  } else {
    ctrl.innerHTML = `
      <button class="control-btn" onclick="doKeyPress('e')">
        <div class="key-text">E</div>
        <div class="key-label">${labels.e}</div>
      </button>
      <button class="control-btn" onclick="doKeyPress('i')">
        <div class="key-text">I</div>
        <div class="key-label">${labels.i}</div>
      </button>
    `;
  }
}

window.hideControls = function() {
  console.log('üö´ HIDE CONTROLS');
  const ctrl = document.getElementById('controls');
  if (ctrl) ctrl.className = '';
}

// ===========================================
// DOWNLOAD FUNCTIONS
// ===========================================
window.downloadCSV = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  const blob = new Blob([EXPERIMENT_DATA.fullCSV], {type: 'text/csv;charset=utf-8'});
  saveAs(blob, `IAT_FullData_${PID}.csv`);
  alert('‚úÖ Full data CSV downloaded!');
}

window.downloadSummary = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  const blob = new Blob([EXPERIMENT_DATA.summaryCSV], {type: 'text/csv;charset=utf-8'});
  saveAs(blob, `IAT_Summary_${PID}.csv`);
  alert('‚úÖ Summary CSV downloaded!');
}

window.downloadBoth = function() {
  downloadSummary();
  setTimeout(() => downloadCSV(), 500);
}

// ===========================================
// JSPSYCH
// ===========================================
const jsPsych = initJsPsych({
  display_element: 'experiment',
  
  on_finish: function() {
    hideControls();
    console.log('üìä PROCESSING DATA');
    processAndDisplayResults();
  },
  
  on_data_update: function(data) {
    data.participant_id = PID;
    data.device = IS_MOBILE ? 'mobile' : 'desktop';
    data.timestamp = new Date().toISOString();
  }
});

function processAndDisplayResults() {
  const allData = jsPsych.data.get();
  
  // Get demographic data
  const demoTrial = allData.filter({trial_type: 'survey-html-form'}).values()[0];
  if (demoTrial && demoTrial.response) {
    DEMOGRAPHIC_DATA = demoTrial.response;
  }
  
  // Get post-test data
  const postTestTrials = allData.filter({phase: 'post_test'}).values();
  postTestTrials.forEach(trial => {
    if (trial.response) {
      Object.assign(POST_TEST_DATA, trial.response);
    }
  });
  
  // Get IAT data
  const iatData = allData.filter([
    {trial_type: 'iat-image'},
    {trial_type: 'iat-html'}
  ]);
  
  const compatible = iatData.filter({block: 'compatible', critical: true});
  const incompatible = iatData.filter({block: 'incompatible', critical: true});
  
  const meanComp = compatible.select('rt').mean();
  const meanIncomp = incompatible.select('rt').mean();
  const sdComp = compatible.select('rt').sd();
  const sdIncomp = incompatible.select('rt').sd();
  const pooledSD = Math.sqrt((sdComp * sdComp + sdIncomp * sdIncomp) / 2);
  const dScore = (meanIncomp - meanComp) / pooledSD;
  
  const correct = iatData.filter({correct: true}).count();
  const total = iatData.count();
  const accuracy = ((correct / total) * 100).toFixed(1);
  const meanRT = iatData.select('rt').mean().toFixed(0);
  
  let interpretation = '';
  let explanation = '';
  
  if (Math.abs(dScore) < 0.15) {
    interpretation = 'No clear preference';
    explanation = 'Response times were similar for both pairings.';
  } else if (dScore > 0.65) {
    interpretation = 'Strong Modi-Positive association';
    explanation = 'Much faster when Modi paired with positive words.';
  } else if (dScore > 0.35) {
    interpretation = 'Moderate Modi-Positive association';
    explanation = 'Noticeably faster when Modi paired with positive words.';
  } else if (dScore > 0) {
    interpretation = 'Slight Modi-Positive association';
    explanation = 'Somewhat faster when Modi paired with positive words.';
  } else if (dScore < -0.65) {
    interpretation = 'Strong Manmohan-Positive association';
    explanation = 'Much faster when Manmohan paired with positive words.';
  } else if (dScore < -0.35) {
    interpretation = 'Moderate Manmohan-Positive association';
    explanation = 'Noticeably faster when Manmohan paired with positive words.';
  } else {
    interpretation = 'Slight Manmohan-Positive association';
    explanation = 'Somewhat faster when Manmohan paired with positive words.';
  }
  
  // Create comprehensive summary CSV
  const summaryCSV = createSummaryCSV(PID, dScore, interpretation, accuracy, meanRT, total, meanComp, meanIncomp);
  
  // Create full trial-by-trial CSV with demographics
  const fullCSV = createFullCSV(iatData);
  
  EXPERIMENT_DATA = {
    id: PID,
    date: new Date().toLocaleString(),
    device: IS_MOBILE ? 'Mobile' : 'Desktop',
    trials: total,
    accuracy: accuracy + '%',
    rt: meanRT + 'ms',
    dscore: dScore.toFixed(3),
    result: interpretation,
    explanation: explanation,
    summaryCSV: summaryCSV,
    fullCSV: fullCSV
  };
  
  console.log('‚úÖ DATA READY');
  showResults();
}

function createSummaryCSV(pid, dscore, interp, acc, rt, trials, rtComp, rtIncomp) {
  let csv = 'participant_id,date_time,device,age,gender,education,political_orientation,state,';
  csv += 'd_score,interpretation,accuracy_percent,mean_rt_ms,total_trials,rt_compatible_ms,rt_incompatible_ms,';
  csv += 'preference_modi,preference_manmohan,awareness_bias,thermometer_modi,thermometer_manmohan,voted_2024\n';
  
  csv += `"${pid}","${new Date().toISOString()}","${IS_MOBILE ? 'Mobile' : 'Desktop'}",`;
  csv += `"${DEMOGRAPHIC_DATA.age || 'NA'}","${DEMOGRAPHIC_DATA.gender || 'NA'}","${DEMOGRAPHIC_DATA.education || 'NA'}",`;
  csv += `"${DEMOGRAPHIC_DATA.political || 'NA'}","${DEMOGRAPHIC_DATA.state || 'NA'}",`;
  csv += `${dscore.toFixed(3)},"${interp}",${acc},${rt},${trials},${rtComp.toFixed(0)},${rtIncomp.toFixed(0)},`;
  csv += `"${POST_TEST_DATA.preference_modi || 'NA'}","${POST_TEST_DATA.preference_manmohan || 'NA'}",`;
  csv += `"${POST_TEST_DATA.awareness || 'NA'}","${POST_TEST_DATA.thermo_modi || 'NA'}","${POST_TEST_DATA.thermo_manmohan || 'NA'}",`;
  csv += `"${POST_TEST_DATA.voted || 'NA'}"\n`;
  
  return csv;
}

function createFullCSV(iatData) {
  let csv = 'participant_id,trial_number,block,stimulus_type,stimulus,correct_response,user_response,correct,rt_ms,';
  csv += 'age,gender,education,political_orientation,state,timestamp\n';
  
  const trials = iatData.values();
  trials.forEach((trial, idx) => {
    csv += `"${PID}",${idx + 1},"${trial.block}","${trial.type}","${trial.stimulus}",`;
    csv += `"${trial.stim_key_association}","${trial.response}",${trial.correct ? 'TRUE' : 'FALSE'},${trial.rt},`;
    csv += `"${DEMOGRAPHIC_DATA.age || 'NA'}","${DEMOGRAPHIC_DATA.gender || 'NA'}","${DEMOGRAPHIC_DATA.education || 'NA'}",`;
    csv += `"${DEMOGRAPHIC_DATA.political || 'NA'}","${DEMOGRAPHIC_DATA.state || 'NA'}","${trial.timestamp}"\n`;
  });
  
  return csv;
}

function showResults() {
  document.getElementById('experiment').innerHTML = `
    <div class="container">
      <div class="box">
        <h1>‚úÖ Experiment Complete!</h1>
        <p>Thank you for participating in this research study.</p>
        
        <div class="success">
          <strong>Your data has been processed and is ready for download.</strong>
        </div>
        
        <div style="background: #f8f9fa; padding: 2vh; border-radius: 8px; margin: 2vh 0;">
          <div class="result-item"><strong>Participant ID:</strong> ${EXPERIMENT_DATA.id}</div>
          <div class="result-item"><strong>Completion Time:</strong> ${EXPERIMENT_DATA.date}</div>
          <div class="result-item"><strong>Device:</strong> ${EXPERIMENT_DATA.device}</div>
          <div class="result-item"><strong>Total Trials:</strong> ${EXPERIMENT_DATA.trials}</div>
          <div class="result-item"><strong>Accuracy:</strong> ${EXPERIMENT_DATA.accuracy}</div>
          <div class="result-item"><strong>Average Response Time:</strong> ${EXPERIMENT_DATA.rt}</div>
          <div class="result-item" style="margin-top: 2vh; padding-top: 2vh; border-top: 2px solid #ddd;">
            <strong>D-Score:</strong> ${EXPERIMENT_DATA.dscore}
          </div>
          <div class="result-item"><strong>Result:</strong> ${EXPERIMENT_DATA.result}</div>
          <div style="margin-top: 2vh; padding: 2vh; background: white; border-radius: 6px;">
            ${EXPERIMENT_DATA.explanation}
          </div>
        </div>
        
        <div class="info">
          <strong>üìä Two data files available:</strong><br>
          <strong>Summary CSV:</strong> One row with all key results & demographics<br>
          <strong>Full CSV:</strong> Trial-by-trial data with demographics
        </div>
        
        <div class="warning">
          <strong>‚ö†Ô∏è IMPORTANT:</strong> Please download and send BOTH files to the researcher!
        </div>
        
        <button class="btn" onclick="downloadBoth()">üì• Download Both Files</button>
        <button class="btn" onclick="downloadSummary()">üìä Download Summary CSV Only</button>
        <button class="btn" onclick="downloadCSV()">üìã Download Full Data CSV Only</button>
      </div>
    </div>
  `;
}

// ===========================================
// TRIAL FUNCTIONS
// ===========================================
function blockIntro(title, left, right, reversed) {
  return {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div class="container">
        <div class="box">
          <h1>${title}</h1>
          ${reversed ? '<div class="warning"><strong>‚ö†Ô∏è CATEGORIES SWITCHED!</strong></div>' : ''}
          <div class="cats">
            <div class="cat">E = ${left}</div>
            <div class="cat">I = ${right}</div>
          </div>
          <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
            ${IS_MOBILE ? 'üëá TAP START üëá' : 'PRESS SPACE'}
          </p>
        </div>
      </div>
    `,
    choices: [' '],
    on_load: function() {
      if (IS_MOBILE) setupControls('single', 'START');
    },
    on_finish: function() {
      hideControls();
    }
  };
}

function imgTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatImage,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'image', critical: crit || false},
    on_load: function() {
      if (IS_MOBILE) setupControls('double', {e: lShort, i: rShort});
    }
  };
}

function wordTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatHtml,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'word', critical: crit || false},
    on_load: function() {
      if (IS_MOBILE) setupControls('double', {e: lShort, i: rShort});
    }
  };
}

// ===========================================
// TIMELINE
// ===========================================
const timeline = [];

// WELCOME
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Political Attitudes Study</h1>
        <h2>Implicit Association Test (IAT)</h2>
        
        <div class="info">
          <strong>Purpose:</strong> This study measures automatic associations between political figures and positive/negative concepts.
        </div>
        
        <p><strong>What you'll do:</strong></p>
        <ul style="margin-left: 3vw; font-size: 2vh; color: #555;">
          <li>Answer some demographic questions</li>
          <li>Complete a categorization task with images and words</li>
          <li>Answer a few follow-up questions</li>
        </ul>
        
        <div class="warning">
          <strong>Time:</strong> Approximately 10-12 minutes<br>
          <strong>Confidentiality:</strong> All responses are anonymous
        </div>
        
        ${IS_MOBILE ? '<p style="color: #d63031; font-weight: 700; text-align: center; margin-top: 2vh;">Please keep device in LANDSCAPE mode</p>' : ''}
        
        <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
          ${IS_MOBILE ? 'üëá TAP TO BEGIN üëá' : 'PRESS ANY KEY TO BEGIN'}
        </p>
      </div>
    </div>
  `,
  on_load: function() {
    if (IS_MOBILE) setupControls('single', 'BEGIN');
  },
  on_finish: function() {
    hideControls();
  }
});

// DEMOGRAPHICS
timeline.push({
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <h1>Part 1: Demographic Information</h1>
    <p>Please answer the following questions about yourself.</p>
  `,
  html: `
    <div style="margin: 2vh 0;">
      <label style="display: block; margin-bottom: 1vh; font-weight: 600;">1. What is your age?</label>
      <input type="number" name="age" min="18" max="100" required style="user-select: text !important;">
    </div>
    
    <div style="margin: 2vh 0;">
      <label style="display: block; margin-bottom: 1vh; font-weight: 600;">2. What is your gender?</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="gender" value="Male" required> Male</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="gender" value="Female" required> Female</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="gender" value="Non-binary" required> Non-binary</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="gender" value="Prefer not to say" required> Prefer not to say</label>
    </div>
    
    <div style="margin: 2vh 0;">
      <label style="display: block; margin-bottom: 1vh; font-weight: 600;">3. What is your highest level of education?</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="education" value="Less than high school" required> Less than high school</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="education" value="High school graduate" required> High school graduate</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="education" value="Some college" required> Some college</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="education" value="Bachelor's degree" required> Bachelor's degree</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="education" value="Graduate degree" required> Graduate degree (Master's, PhD, etc.)</label>
    </div>
    
    <div style="margin: 2vh 0;">
      <label style="display: block; margin-bottom: 1vh; font-weight: 600;">4. Which state/union territory do you currently reside in?</label>
      <input type="text" name="state" required placeholder="e.g., Maharashtra, Delhi" style="user-select: text !important;">
    </div>
    
    <div style="margin: 2vh 0;">
      <label style="display: block; margin-bottom: 1vh; font-weight: 600;">5. How would you describe your political orientation?</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="political" value="Very liberal" required> Very liberal</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="political" value="Liberal" required> Liberal</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="political" value="Moderate" required> Moderate</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="political" value="Conservative" required> Conservative</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="political" value="Very conservative" required> Very conservative</label>
      <label style="display: block; margin: 0.5vh 0;"><input type="radio" name="political" value="No preference" required> No preference</label>
    </div>
  `,
  button_label: 'Continue',
  on_load: function() {
    hideControls();
  }
});

// IAT INSTRUCTIONS
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Part 2: Categorization Task</h1>
        
        <p>In this task, you will see:</p>
        <ul style="margin-left: 3vw; font-size: 2vh; color: #555; line-height: 1.6;">
          <li>Photos of <strong>Narendra Modi</strong></li>
          <li>Photos of <strong>Dr. Manmohan Singh</strong></li>
          <li><strong>Positive words</strong> (e.g., Lovely, Joyous, Beautiful)</li>
          <li><strong>Negative words</strong> (e.g., Pain, Tragic, Disgust)</li>
        </ul>
        
        <div class="info">
          <strong>Your task:</strong> Sort items into categories as quickly as possible using the E and I keys.
        </div>
        
        <div class="cats">
          <div class="cat">E = Left category</div>
          <div class="cat">I = Right category</div>
        </div>
        
        <div class="warning">
          <strong>Important:</strong><br>
          ‚Ä¢ Respond as <strong>fast</strong> as you can<br>
          ‚Ä¢ Mistakes are normal - just press the correct key when you see an ‚úï<br>
          ‚Ä¢ Categories will switch partway through
        </div>
        
        <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
          ${IS_MOBILE ? 'üëá TAP TO START üëá' : 'PRESS SPACE TO START'}
        </p>
      </div>
    </div>
  `,
  choices: [' '],
  on_load: function() {
    if (IS_MOBILE) setupControls('single', 'START');
  },
  on_finish: function() {
    hideControls();
  }
});

// BLOCK 1: Modi vs Manmohan
timeline.push(blockIntro('Practice: Categorize Leaders', 'Modi', 'Manmohan', false));
timeline.push({
  timeline: [imgTrial('practice1', 'Modi', 'Manmohan', 'Modi', 'Manmohan')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 2
});

// BLOCK 2: Positive vs Negative
timeline.push(blockIntro('Practice: Categorize Words', 'Positive', 'Negative', false));
timeline.push({
  timeline: [wordTrial('practice2', 'Positive', 'Negative', 'Positive', 'Negative')],
  timeline_variables: [
    ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
    ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 3: Combined Practice (Compatible)
timeline.push(blockIntro('Practice: Combined Task', 'Modi or Positive', 'Manmohan or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 4: CRITICAL Compatible
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// BLOCK 5: Reversed Leaders
timeline.push(blockIntro('Practice: Switched Categories', 'Manmohan', 'Modi', true));
timeline.push({
  timeline: [imgTrial('practice4', 'Manmohan', 'Modi', 'Manmohan', 'Modi')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
  ],
  randomize_order: true,
  repetitions: 5
});

// BLOCK 6: Combined Practice (Incompatible)
timeline.push(blockIntro('Practice: Combined Task', 'Manmohan or Positive', 'Modi or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 7: CRITICAL Incompatible
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// POST-TEST QUESTIONS
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Part 3: Follow-up Questions</h1>
        <p>You're almost done! Just a few more questions.</p>
        <p style="text-align: center; font-weight: 700; margin-top: 3vh; font-size: 3vh;">
          ${IS_MOBILE ? 'üëá TAP CONTINUE üëá' : 'PRESS ANY KEY'}
        </p>
      </div>
    </div>
  `,
  on_load: function() {
    if (IS_MOBILE) setupControls('single', 'CONTINUE');
  },
  on_finish: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Which statement best describes your feelings toward Narendra Modi?",
      name: 'preference_modi',
      options: [
        'I strongly prefer Modi over Manmohan Singh',
        'I moderately prefer Modi over Manmohan Singh',
        'I slightly prefer Modi over Manmohan Singh',
        'I like Modi and Manmohan Singh equally',
        'I slightly prefer Manmohan Singh over Modi',
        'I moderately prefer Manmohan Singh over Modi',
        'I strongly prefer Manmohan Singh over Modi'
      ],
      required: true
    }
  ],
  data: {phase: 'post_test'},
  on_load: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Which statement best describes your feelings toward Dr. Manmohan Singh?",
      name: 'preference_manmohan',
      options: [
        'I strongly prefer Manmohan Singh over Modi',
        'I moderately prefer Manmohan Singh over Modi',
        'I slightly prefer Manmohan Singh over Modi',
        'I like Manmohan Singh and Modi equally',
        'I slightly prefer Modi over Manmohan Singh',
        'I moderately prefer Modi over Manmohan Singh',
        'I strongly prefer Modi over Manmohan Singh'
      ],
      required: true
    }
  ],
  data: {phase: 'post_test'},
  on_load: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychSurveyLikert,
  questions: [
    {
      prompt: "How would you rate Narendra Modi? (0 = Very unfavorable, 10 = Very favorable)",
      name: 'thermo_modi',
      labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
      required: true
    }
  ],
  data: {phase: 'post_test'},
  on_load: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychSurveyLikert,
  questions: [
    {
      prompt: "How would you rate Dr. Manmohan Singh? (0 = Very unfavorable, 10 = Very favorable)",
      name: 'thermo_manmohan',
      labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
      required: true
    }
  ],
  data: {phase: 'post_test'},
  on_load: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Before this study, how aware were you that you might have automatic preferences between these political figures?",
      name: 'awareness',
      options: [
        'Very aware',
        'Somewhat aware',
        'A little aware',
        'Not at all aware'
      ],
      required: true
    }
  ],
  data: {phase: 'post_test'},
  on_load: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Did you vote in the 2024 Lok Sabha elections?",
      name: 'voted',
      options: [
        'Yes',
        'No',
        'Prefer not to say'
      ],
      required: true
    }
  ],
  data: {phase: 'post_test'},
  on_load: function() {
    hideControls();
  }
});

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Processing Your Results...</h1>
        <p style="text-align: center; font-size: 3vh;">Please wait a moment.</p>
      </div>
    </div>
  `,
  trial_duration: 2000,
  response_ends_trial: false,
  on_load: function() {
    hideControls();
  }
});

console.log('üöÄ STARTING EXPERIMENT');
jsPsych.run(timeline);
</script>
</html>
