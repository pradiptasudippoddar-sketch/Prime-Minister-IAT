<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IAT Study</title>

  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
  
  <!-- FileSaver for reliable downloads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f0f0f0;
      padding-bottom: 150px;
    }
    
    .container {
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
    }
    
    .box {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 15px;
      color: #222;
    }
    
    p {
      font-size: 16px;
      line-height: 1.6;
      color: #555;
      margin-bottom: 10px;
    }
    
    .cats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    
    .cat {
      background: #2c3e50;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }
    
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    
    .success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 0;
    }
    
    .btn:active {
      background: #34495e;
    }
    
    /* FIXED MOBILE BUTTONS */
    .touch-btns {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 3px solid #ccc;
      padding: 15px;
      display: none;
      gap: 15px;
      z-index: 99999;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
    }
    
    .touch-btns.active {
      display: flex !important;
    }
    
    .touch-btn {
      flex: 1;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 25px 15px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
    }
    
    .touch-btn:active {
      background: #34495e;
      transform: scale(0.95);
    }
    
    /* TRIAL STYLES */
    .jspsych-iat-stim {
      font-size: 44px !important;
      font-weight: 600 !important;
      margin: 50px auto !important;
      text-align: center !important;
    }
    
    .jspsych-iat-stim img {
      max-width: 75vw !important;
      max-height: 40vh !important;
      border-radius: 10px;
      display: block !important;
      margin: 0 auto !important;
    }
    
    .error-mark {
      color: #e74c3c !important;
      font-size: 70px !important;
    }
    
    .jspsych-iat-category {
      font-weight: 600 !important;
      font-size: 14px !important;
      padding: 12px 18px !important;
      border: 2px solid #2c3e50 !important;
      border-radius: 8px !important;
      margin: 10px !important;
    }
    
    .jspsych-display-element > p {
      font-size: 14px !important;
      color: #777 !important;
      margin-top: 30px !important;
      padding: 0 20px 120px !important;
      text-align: center !important;
    }
    
    .result-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      
      .box {
        padding: 20px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      .jspsych-iat-stim {
        font-size: 38px !important;
      }
    }
  </style>
</head>

<body>
  <div id="experiment"></div>
  <div class="touch-btns" id="controls"></div>
</body>

<script>
// ===========================================
// GLOBAL SETUP
// ===========================================
const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 768;
const PID = 'P' + Date.now();
let EXPERIMENT_DATA = null;

console.log('=== IAT STARTED ===');
console.log('Participant:', PID);
console.log('Device:', IS_MOBILE ? 'MOBILE' : 'DESKTOP');

// ===========================================
// STIMULI
// ===========================================
const IMG_MODI = ['imagesmodi1.jpg.jpeg', 'imagesmodi2.jpg.jpeg', 'imagesmodi3.jpg.jpeg', 'imagesmodi4.jpg.jpeg'];
const IMG_MANMOHAN = ['imagesprevious1.jpg.jpeg', 'imagesprevious2.jpg.jpeg', 'imagesprevious3.jpg.jpeg', 'imagesprevious4.jpg.jpeg'];
const WORDS_POS = ['Wonderful', 'Happy', 'Joy', 'Love', 'Peace', 'Pleasure', 'Glorious', 'Laughter', 'Success', 'Hope'];
const WORDS_NEG = ['Terrible', 'Awful', 'Horrible', 'Evil', 'Nasty', 'Failure', 'Agony', 'Pain', 'Disaster', 'Tragedy'];

// ===========================================
// MOBILE CONTROLS - COMPLETELY REWRITTEN
// ===========================================
window.pressKey = function(key) {
  console.log('KEY PRESSED:', key);
  
  const codes = {
    'e': {keyCode: 69, code: 'KeyE', key: 'e'},
    'i': {keyCode: 73, code: 'KeyI', key: 'i'},
    ' ': {keyCode: 32, code: 'Space', key: ' '}
  };
  
  const info = codes[key];
  
  // Create and dispatch keydown event
  const downEvent = new KeyboardEvent('keydown', {
    bubbles: true,
    cancelable: true,
    key: info.key,
    code: info.code,
    keyCode: info.keyCode,
    which: info.keyCode
  });
  
  document.dispatchEvent(downEvent);
  
  // Create and dispatch keyup event after short delay
  setTimeout(() => {
    const upEvent = new KeyboardEvent('keyup', {
      bubbles: true,
      cancelable: true,
      key: info.key,
      code: info.code,
      keyCode: info.keyCode,
      which: info.keyCode
    });
    document.dispatchEvent(upEvent);
  }, 100);
}

function setControls(type, labels) {
  const ctrl = document.getElementById('controls');
  if (!ctrl || !IS_MOBILE) return;
  
  ctrl.innerHTML = '';
  ctrl.className = 'touch-btns active';
  
  if (type === 'single') {
    const btn = document.createElement('button');
    btn.className = 'touch-btn';
    btn.textContent = labels;
    btn.setAttribute('onclick', "pressKey(' ')");
    ctrl.appendChild(btn);
  } else {
    const btnE = document.createElement('button');
    btnE.className = 'touch-btn';
    btnE.innerHTML = `E<br><small>${labels.e}</small>`;
    btnE.setAttribute('onclick', "pressKey('e')");
    
    const btnI = document.createElement('button');
    btnI.className = 'touch-btn';
    btnI.innerHTML = `I<br><small>${labels.i}</small>`;
    btnI.setAttribute('onclick', "pressKey('i')");
    
    ctrl.appendChild(btnE);
    ctrl.appendChild(btnI);
  }
}

function clearControls() {
  const ctrl = document.getElementById('controls');
  if (ctrl) {
    ctrl.className = 'touch-btns';
    ctrl.innerHTML = '';
  }
}

// ===========================================
// FILE DOWNLOAD - USING FILESAVER.JS
// ===========================================
window.downloadCSV = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  
  const blob = new Blob([EXPERIMENT_DATA.csv], {type: 'text/csv;charset=utf-8'});
  saveAs(blob, `IAT_${PID}.csv`);
  alert('‚úÖ CSV file downloaded!\n\nPlease send this file to the researcher.');
}

window.downloadSummary = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  
  const summary = `IAT EXPERIMENT RESULTS
=======================

Participant ID: ${EXPERIMENT_DATA.id}
Date & Time: ${EXPERIMENT_DATA.date}
Device: ${EXPERIMENT_DATA.device}

PERFORMANCE:
-----------
Total Trials: ${EXPERIMENT_DATA.trials}
Accuracy: ${EXPERIMENT_DATA.accuracy}
Mean Response Time: ${EXPERIMENT_DATA.rt}

RESULTS:
--------
D-Score: ${EXPERIMENT_DATA.dscore}
Interpretation: ${EXPERIMENT_DATA.result}

WHAT THIS MEANS:
${EXPERIMENT_DATA.explanation}
`;
  
  const blob = new Blob([summary], {type: 'text/plain;charset=utf-8'});
  saveAs(blob, `IAT_Summary_${PID}.txt`);
  alert('‚úÖ Summary downloaded!');
}

window.downloadBoth = function() {
  downloadCSV();
  setTimeout(() => downloadSummary(), 500);
}

// ===========================================
// JSPSYCH INITIALIZATION
// ===========================================
const jsPsych = initJsPsych({
  display_element: 'experiment',
  
  on_finish: function() {
    clearControls();
    
    console.log('=== PROCESSING DATA ===');
    
    // Get all IAT data
    const allData = jsPsych.data.get();
    const iatData = allData.filter([
      {trial_type: 'iat-image'},
      {trial_type: 'iat-html'}
    ]);
    
    // Get critical trials
    const compatible = iatData.filter({block: 'compatible', critical: true});
    const incompatible = iatData.filter({block: 'incompatible', critical: true});
    
    // Calculate D-score
    const meanComp = compatible.select('rt').mean();
    const meanIncomp = incompatible.select('rt').mean();
    const sdComp = compatible.select('rt').sd();
    const sdIncomp = incompatible.select('rt').sd();
    const pooledSD = Math.sqrt((sdComp * sdComp + sdIncomp * sdIncomp) / 2);
    const dScore = (meanIncomp - meanComp) / pooledSD;
    
    // Calculate accuracy
    const correct = iatData.filter({correct: true}).count();
    const total = iatData.count();
    const accuracy = ((correct / total) * 100).toFixed(1);
    const meanRT = iatData.select('rt').mean().toFixed(0);
    
    // Interpret D-score
    let interpretation = '';
    let explanation = '';
    
    if (Math.abs(dScore) < 0.15) {
      interpretation = 'No clear preference';
      explanation = 'Your response times were similar for both pairings, suggesting no strong automatic preference.';
    } else if (dScore > 0.65) {
      interpretation = 'Strong Modi-Positive association';
      explanation = 'You were much faster when Modi was paired with positive words, suggesting a strong automatic positive association.';
    } else if (dScore > 0.35) {
      interpretation = 'Moderate Modi-Positive association';
      explanation = 'You were noticeably faster when Modi was paired with positive words.';
    } else if (dScore > 0) {
      interpretation = 'Slight Modi-Positive association';
      explanation = 'You were somewhat faster when Modi was paired with positive words.';
    } else if (dScore < -0.65) {
      interpretation = 'Strong Manmohan-Positive association';
      explanation = 'You were much faster when Manmohan was paired with positive words, suggesting a strong automatic positive association.';
    } else if (dScore < -0.35) {
      interpretation = 'Moderate Manmohan-Positive association';
      explanation = 'You were noticeably faster when Manmohan was paired with positive words.';
    } else {
      interpretation = 'Slight Manmohan-Positive association';
      explanation = 'You were somewhat faster when Manmohan was paired with positive words.';
    }
    
    // Prepare CSV
    const csv = iatData.csv();
    
    // Store globally
    EXPERIMENT_DATA = {
      id: PID,
      date: new Date().toLocaleString(),
      device: IS_MOBILE ? 'Mobile' : 'Desktop',
      trials: total,
      accuracy: accuracy + '%',
      rt: meanRT + 'ms',
      dscore: dScore.toFixed(3),
      result: interpretation,
      explanation: explanation,
      csv: csv
    };
    
    console.log('=== DATA READY ===');
    console.log(EXPERIMENT_DATA);
    
    // Display results
    showResults();
  },
  
  on_data_update: function(data) {
    data.participant_id = PID;
    data.device = IS_MOBILE ? 'mobile' : 'desktop';
    data.timestamp = new Date().toISOString();
  }
});

// ===========================================
// RESULTS DISPLAY
// ===========================================
function showResults() {
  document.getElementById('experiment').innerHTML = `
    <div class="container">
      <div class="box">
        <h1>‚úÖ Experiment Complete!</h1>
        <p>Thank you for participating in this study.</p>
        
        <div class="success">
          <strong>Your data has been prepared for download.</strong>
        </div>
        
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <div class="result-item">
            <strong>Participant ID:</strong> ${EXPERIMENT_DATA.id}
          </div>
          <div class="result-item">
            <strong>Date:</strong> ${EXPERIMENT_DATA.date}
          </div>
          <div class="result-item">
            <strong>Device:</strong> ${EXPERIMENT_DATA.device}
          </div>
          <div class="result-item">
            <strong>Trials Completed:</strong> ${EXPERIMENT_DATA.trials}
          </div>
          <div class="result-item">
            <strong>Accuracy:</strong> ${EXPERIMENT_DATA.accuracy}
          </div>
          <div class="result-item">
            <strong>Avg Response Time:</strong> ${EXPERIMENT_DATA.rt}
          </div>
          <div class="result-item" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd;">
            <strong>D-Score:</strong> ${EXPERIMENT_DATA.dscore}
          </div>
          <div class="result-item">
            <strong>Result:</strong> ${EXPERIMENT_DATA.result}
          </div>
          <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">
            <small>${EXPERIMENT_DATA.explanation}</small>
          </div>
        </div>
        
        <div class="warning">
          <strong>‚ö†Ô∏è IMPORTANT:</strong> Please download your data and send it to the researcher!
        </div>
        
        <button class="btn" onclick="downloadBoth()">üì• Download All Data (CSV + Summary)</button>
        <button class="btn" onclick="downloadCSV()">üìä Download CSV Only</button>
        <button class="btn" onclick="downloadSummary()">üìÑ Download Summary Only</button>
      </div>
    </div>
  `;
}

// ===========================================
// TIMELINE
// ===========================================
const timeline = [];

// Welcome
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Implicit Association Test</h1>
        <p><strong>Research Study on Political Attitudes</strong></p>
        <p>This study measures automatic associations between political figures and positive/negative words.</p>
        
        <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <p><strong>You will see:</strong></p>
          <p>‚Ä¢ Photos of Narendra Modi<br>
          ‚Ä¢ Photos of Dr. Manmohan Singh<br>
          ‚Ä¢ Positive words (wonderful, happy, etc.)<br>
          ‚Ä¢ Negative words (terrible, awful, etc.)</p>
        </div>
        
        <div class="warning">
          <strong>Duration:</strong> 5-7 minutes<br>
          <strong>Respond as quickly as possible!</strong>
        </div>
        
        <p style="text-align: center; font-weight: 600; margin-top: 30px;">
          ${IS_MOBILE ? 'üëá Tap CONTINUE below' : 'Press any key to start'}
        </p>
      </div>
    </div>
  `,
  on_load: () => {
    if (IS_MOBILE) setControls('single', 'CONTINUE');
  },
  on_finish: () => clearControls()
});

// Instructions
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Instructions</h1>
        <p>Categorize each item using the ${IS_MOBILE ? '<strong>E and I buttons</strong> at the bottom' : '<strong>E and I keys</strong>'}.</p>
        
        <div class="cats">
          <div class="cat">E<br><small>Left Category</small></div>
          <div class="cat">I<br><small>Right Category</small></div>
        </div>
        
        <div class="warning">
          <strong>If you make an error:</strong> An ‚úï will appear. Press the ${IS_MOBILE ? 'other button' : 'correct key'}.
        </div>
        
        <p style="text-align: center; font-weight: 600; margin-top: 30px;">
          ${IS_MOBILE ? 'üëá Tap BEGIN' : 'Press SPACE to begin'}
        </p>
      </div>
    </div>
  `,
  choices: [' '],
  on_load: () => {
    if (IS_MOBILE) setControls('single', 'BEGIN');
  },
  on_finish: () => clearControls()
});

// Block instructions
function blockIntro(title, left, right, reversed) {
  return {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div class="container">
        <div class="box">
          <h1>${title}</h1>
          ${reversed ? '<div class="warning"><strong>‚ö†Ô∏è CATEGORIES SWITCHED SIDES!</strong></div>' : ''}
          <div class="cats">
            <div class="cat">E<br>${left}</div>
            <div class="cat">I<br>${right}</div>
          </div>
          <p style="text-align: center; font-weight: 600; margin-top: 30px;">
            ${IS_MOBILE ? 'üëá Tap START' : 'Press SPACE'}
          </p>
        </div>
      </div>
    `,
    choices: [' '],
    on_load: () => {
      if (IS_MOBILE) setControls('single', 'START');
    },
    on_finish: () => clearControls()
  };
}

// Image trial
function imgTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatImage,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'image', critical: crit || false},
    on_load: () => {
      if (IS_MOBILE) setControls('double', {e: lShort, i: rShort});
    }
  };
}

// Word trial
function wordTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatHtml,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'word', critical: crit || false},
    on_load: () => {
      if (IS_MOBILE) setControls('double', {e: lShort, i: rShort});
    }
  };
}

// BLOCK 1
timeline.push(blockIntro('Categorize Political Figures', 'Modi', 'Manmohan', false));
timeline.push({
  timeline: [imgTrial('practice1', 'Modi', 'Manmohan', 'Modi', 'Manmohan')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 2
});

// BLOCK 2
timeline.push(blockIntro('Categorize Words', 'Positive', 'Negative', false));
timeline.push({
  timeline: [wordTrial('practice2', 'Positive', 'Negative', 'Positive', 'Negative')],
  timeline_variables: [
    ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
    ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 3
timeline.push(blockIntro('Combined Task', 'Modi or Positive', 'Manmohan or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 4 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// BLOCK 5
timeline.push(blockIntro('Categorize Political Figures', 'Manmohan', 'Modi', true));
timeline.push({
  timeline: [imgTrial('practice4', 'Manmohan', 'Modi', 'Manmohan', 'Modi')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
  ],
  randomize_order: true,
  repetitions: 5
});

// BLOCK 6
timeline.push(blockIntro('Combined Task', 'Manmohan or Positive', 'Modi or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 7 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// Debrief
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Almost Done!</h1>
        <p>You have completed all trials.</p>
        <div class="success">
          The IAT measures automatic associations by comparing your response times when different concepts are paired together.
        </div>
        <p style="text-align: center; font-weight: 600; margin-top: 30px;">
          ${IS_MOBILE ? 'üëá Tap to see your results' : 'Press any key for results'}
        </p>
      </div>
    </div>
  `,
  on_load: () => {
    if (IS_MOBILE) setControls('single', 'VIEW RESULTS');
  },
  on_finish: () => clearControls()
});

// START EXPERIMENT
jsPsych.run(timeline);
</script>
</html>
