<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>IAT Study</title>

  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
  
  <!-- FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      background: #f0f0f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow-x: hidden;
      position: fixed;
    }
    
    body {
      padding-bottom: 140px;
      padding-bottom: calc(140px + env(safe-area-inset-bottom));
      overflow-y: auto;
    }
    
    .container {
      max-width: 600px;
      margin: 20px auto;
      padding: 15px;
    }
    
    .box {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 12px;
      color: #222;
    }
    
    p {
      font-size: 16px;
      line-height: 1.5;
      color: #555;
      margin-bottom: 10px;
    }
    
    .cats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }
    
    .cat {
      background: #2c3e50;
      color: white;
      padding: 18px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
    }
    
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 12px;
      margin: 15px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 8px 0;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .btn:active {
      background: #34495e;
      transform: scale(0.98);
    }
    
    /* MOBILE TOUCH BUTTONS */
    #touch-pad {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 3px solid #ccc;
      padding: 15px;
      padding-bottom: calc(15px + env(safe-area-inset-bottom));
      display: none;
      gap: 12px;
      z-index: 999999;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
    }
    
    #touch-pad.visible {
      display: flex !important;
    }
    
    .touch-key {
      flex: 1;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 25px 10px;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      position: relative;
      transition: all 0.1s;
      box-shadow: 0 4px 0 #1e8449;
    }
    
    .touch-key:active {
      background: #229954;
      transform: translateY(4px);
      box-shadow: 0 0 0 #1e8449;
    }
    
    .touch-key.pressed {
      background: #229954;
      transform: translateY(4px);
      box-shadow: 0 0 0 #1e8449;
    }
    
    .key-letter {
      display: block;
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 5px;
    }
    
    .key-label {
      display: block;
      font-size: 11px;
      opacity: 0.9;
      text-transform: uppercase;
    }
    
    /* TRIAL DISPLAY */
    .jspsych-iat-stim {
      font-size: 44px !important;
      font-weight: 700 !important;
      color: #222 !important;
      margin: 50px auto !important;
      text-align: center !important;
      padding: 0 20px !important;
    }
    
    .jspsych-iat-stim img {
      max-width: 75vw !important;
      max-height: 40vh !important;
      border-radius: 10px;
      display: block !important;
      margin: 0 auto !important;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .error-mark {
      color: #e74c3c !important;
      font-size: 80px !important;
      font-weight: 900 !important;
    }
    
    .jspsych-iat-category {
      font-weight: 700 !important;
      font-size: 14px !important;
      padding: 10px 16px !important;
      border: 3px solid #2c3e50 !important;
      border-radius: 8px !important;
      margin: 8px !important;
      background: white !important;
    }
    
    .jspsych-display-element > p {
      font-size: 14px !important;
      color: #777 !important;
      margin-top: 30px !important;
      padding: 0 20px 130px !important;
      text-align: center !important;
      font-weight: 600 !important;
    }
    
    .result-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    /* VISUAL FEEDBACK */
    @keyframes flash {
      0%, 100% { background: #27ae60; }
      50% { background: #2ecc71; }
    }
    
    .touch-key.flash {
      animation: flash 0.3s ease;
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }
      
      .box {
        padding: 20px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      .jspsych-iat-stim {
        font-size: 38px !important;
        margin: 35px auto !important;
      }
    }
  </style>
</head>

<body>
  <div id="experiment"></div>
  <div id="touch-pad"></div>
</body>

<script>
// ===========================================
// DETECT MOBILE - AGGRESSIVE CHECK
// ===========================================
const IS_MOBILE = (function() {
  const ua = navigator.userAgent.toLowerCase();
  const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
  const isSmallScreen = window.innerWidth <= 768;
  const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
  
  return isMobileUA || isSmallScreen || isTouchDevice;
})();

const PID = 'P' + Date.now();
let EXPERIMENT_DATA = null;

console.log('=== IAT STARTED ===');
console.log('Mobile Detected:', IS_MOBILE);
console.log('User Agent:', navigator.userAgent);
console.log('Screen Width:', window.innerWidth);
console.log('Touch Points:', navigator.maxTouchPoints);
console.log('Participant ID:', PID);

// ===========================================
// STIMULI
// ===========================================
const IMG_MODI = ['imagesmodi1.jpg.jpeg', 'imagesmodi2.jpg.jpeg', 'imagesmodi3.jpg.jpeg', 'imagesmodi4.jpg.jpeg'];
const IMG_MANMOHAN = ['imagesprevious1.jpg.jpeg', 'imagesprevious2.jpg.jpeg', 'imagesprevious3.jpg.jpeg', 'imagesprevious4.jpg.jpeg'];
const WORDS_POS = ['Wonderful', 'Happy', 'Joy', 'Love', 'Peace', 'Pleasure', 'Glorious', 'Laughter', 'Success', 'Hope'];
const WORDS_NEG = ['Terrible', 'Awful', 'Horrible', 'Evil', 'Nasty', 'Failure', 'Agony', 'Pain', 'Disaster', 'Tragedy'];

// ===========================================
// KEY SIMULATION - MULTIPLE METHODS
// ===========================================
function simulateKeyPress(key) {
  console.log('üì± SIMULATING KEY:', key);
  
  const keyMap = {
    'e': { key: 'e', code: 'KeyE', keyCode: 69, which: 69 },
    'i': { key: 'i', code: 'KeyI', keyCode: 73, which: 73 },
    ' ': { key: ' ', code: 'Space', keyCode: 32, which: 32 }
  };
  
  const info = keyMap[key];
  
  // METHOD 1: KeyboardEvent
  const keydownEvent = new KeyboardEvent('keydown', {
    key: info.key,
    code: info.code,
    keyCode: info.keyCode,
    which: info.which,
    bubbles: true,
    cancelable: true,
    view: window
  });
  
  const keyupEvent = new KeyboardEvent('keyup', {
    key: info.key,
    code: info.code,
    keyCode: info.keyCode,
    which: info.which,
    bubbles: true,
    cancelable: true,
    view: window
  });
  
  document.dispatchEvent(keydownEvent);
  window.dispatchEvent(keydownEvent);
  document.body.dispatchEvent(keydownEvent);
  
  setTimeout(() => {
    document.dispatchEvent(keyupEvent);
    window.dispatchEvent(keyupEvent);
    document.body.dispatchEvent(keyupEvent);
  }, 100);
  
  // METHOD 2: Try deprecated initKeyboardEvent for older browsers
  try {
    const oldDown = document.createEvent('KeyboardEvent');
    if (oldDown.initKeyboardEvent) {
      oldDown.initKeyboardEvent('keydown', true, true, window, info.key, 0, false, false, false, false);
      document.dispatchEvent(oldDown);
    }
  } catch(e) {}
  
  // Visual feedback
  flashButton(key);
}

function flashButton(key) {
  const buttons = document.querySelectorAll('.touch-key');
  buttons.forEach(btn => {
    if (btn.dataset.key === key) {
      btn.classList.add('flash', 'pressed');
      setTimeout(() => {
        btn.classList.remove('flash', 'pressed');
      }, 200);
    }
  });
}

// ===========================================
// MOBILE CONTROLS - COMPLETELY REWRITTEN
// ===========================================
function setupTouchControls(mode, labels) {
  console.log('üéÆ SETTING UP CONTROLS:', mode, labels);
  
  const pad = document.getElementById('touch-pad');
  if (!pad || !IS_MOBILE) {
    console.log('‚ùå No touch pad or not mobile');
    return;
  }
  
  pad.innerHTML = '';
  pad.className = 'visible';
  
  if (mode === 'single') {
    // Single continue button
    const btn = document.createElement('button');
    btn.className = 'touch-key';
    btn.dataset.key = ' ';
    btn.innerHTML = `<span class="key-letter">TAP</span><span class="key-label">${labels}</span>`;
    
    // Multiple event listeners for maximum compatibility
    btn.addEventListener('touchstart', function(e) {
      e.preventDefault();
      console.log('üëÜ TOUCHSTART');
      simulateKeyPress(' ');
    }, { passive: false });
    
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('üñ±Ô∏è CLICK');
      simulateKeyPress(' ');
    }, { passive: false });
    
    btn.addEventListener('mousedown', function(e) {
      e.preventDefault();
      console.log('üñ±Ô∏è MOUSEDOWN');
      simulateKeyPress(' ');
    }, { passive: false });
    
    pad.appendChild(btn);
    
  } else if (mode === 'double') {
    // E and I buttons
    const btnE = document.createElement('button');
    btnE.className = 'touch-key';
    btnE.dataset.key = 'e';
    btnE.innerHTML = `<span class="key-letter">E</span><span class="key-label">${labels.e}</span>`;
    
    const btnI = document.createElement('button');
    btnI.className = 'touch-key';
    btnI.dataset.key = 'i';
    btnI.innerHTML = `<span class="key-letter">I</span><span class="key-label">${labels.i}</span>`;
    
    // E button events
    btnE.addEventListener('touchstart', function(e) {
      e.preventDefault();
      console.log('üëÜ TOUCHSTART E');
      simulateKeyPress('e');
    }, { passive: false });
    
    btnE.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('üñ±Ô∏è CLICK E');
      simulateKeyPress('e');
    }, { passive: false });
    
    btnE.addEventListener('mousedown', function(e) {
      e.preventDefault();
      console.log('üñ±Ô∏è MOUSEDOWN E');
      simulateKeyPress('e');
    }, { passive: false });
    
    // I button events
    btnI.addEventListener('touchstart', function(e) {
      e.preventDefault();
      console.log('üëÜ TOUCHSTART I');
      simulateKeyPress('i');
    }, { passive: false });
    
    btnI.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('üñ±Ô∏è CLICK I');
      simulateKeyPress('i');
    }, { passive: false });
    
    btnI.addEventListener('mousedown', function(e) {
      e.preventDefault();
      console.log('üñ±Ô∏è MOUSEDOWN I');
      simulateKeyPress('i');
    }, { passive: false });
    
    pad.appendChild(btnE);
    pad.appendChild(btnI);
  }
  
  console.log('‚úÖ CONTROLS READY');
}

function hideTouchControls() {
  console.log('üö´ HIDING CONTROLS');
  const pad = document.getElementById('touch-pad');
  if (pad) {
    pad.className = '';
    pad.innerHTML = '';
  }
}

// ===========================================
// FILE DOWNLOADS
// ===========================================
window.downloadCSV = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  const blob = new Blob([EXPERIMENT_DATA.csv], {type: 'text/csv;charset=utf-8'});
  saveAs(blob, `IAT_${PID}.csv`);
  alert('‚úÖ CSV downloaded!\n\nSend this file to the researcher.');
}

window.downloadSummary = function() {
  if (!EXPERIMENT_DATA) {
    alert('No data available!');
    return;
  }
  const summary = `IAT EXPERIMENT RESULTS
=======================

Participant ID: ${EXPERIMENT_DATA.id}
Date & Time: ${EXPERIMENT_DATA.date}
Device: ${EXPERIMENT_DATA.device}

PERFORMANCE:
Total Trials: ${EXPERIMENT_DATA.trials}
Accuracy: ${EXPERIMENT_DATA.accuracy}
Mean RT: ${EXPERIMENT_DATA.rt}

RESULTS:
D-Score: ${EXPERIMENT_DATA.dscore}
Interpretation: ${EXPERIMENT_DATA.result}

${EXPERIMENT_DATA.explanation}
`;
  const blob = new Blob([summary], {type: 'text/plain;charset=utf-8'});
  saveAs(blob, `IAT_Summary_${PID}.txt`);
  alert('‚úÖ Summary downloaded!');
}

window.downloadBoth = function() {
  downloadCSV();
  setTimeout(() => downloadSummary(), 500);
}

// ===========================================
// JSPSYCH INITIALIZATION
// ===========================================
const jsPsych = initJsPsych({
  display_element: 'experiment',
  
  on_finish: function() {
    hideTouchControls();
    console.log('üìä EXPERIMENT FINISHED - PROCESSING DATA');
    
    const allData = jsPsych.data.get();
    const iatData = allData.filter([
      {trial_type: 'iat-image'},
      {trial_type: 'iat-html'}
    ]);
    
    const compatible = iatData.filter({block: 'compatible', critical: true});
    const incompatible = iatData.filter({block: 'incompatible', critical: true});
    
    const meanComp = compatible.select('rt').mean();
    const meanIncomp = incompatible.select('rt').mean();
    const sdComp = compatible.select('rt').sd();
    const sdIncomp = incompatible.select('rt').sd();
    const pooledSD = Math.sqrt((sdComp * sdComp + sdIncomp * sdIncomp) / 2);
    const dScore = (meanIncomp - meanComp) / pooledSD;
    
    const correct = iatData.filter({correct: true}).count();
    const total = iatData.count();
    const accuracy = ((correct / total) * 100).toFixed(1);
    const meanRT = iatData.select('rt').mean().toFixed(0);
    
    let interpretation = '';
    let explanation = '';
    
    if (Math.abs(dScore) < 0.15) {
      interpretation = 'No clear preference';
      explanation = 'Response times were similar for both pairings.';
    } else if (dScore > 0.65) {
      interpretation = 'Strong Modi-Positive association';
      explanation = 'Much faster when Modi paired with positive words.';
    } else if (dScore > 0.35) {
      interpretation = 'Moderate Modi-Positive association';
      explanation = 'Noticeably faster when Modi paired with positive words.';
    } else if (dScore > 0) {
      interpretation = 'Slight Modi-Positive association';
      explanation = 'Somewhat faster when Modi paired with positive words.';
    } else if (dScore < -0.65) {
      interpretation = 'Strong Manmohan-Positive association';
      explanation = 'Much faster when Manmohan paired with positive words.';
    } else if (dScore < -0.35) {
      interpretation = 'Moderate Manmohan-Positive association';
      explanation = 'Noticeably faster when Manmohan paired with positive words.';
    } else {
      interpretation = 'Slight Manmohan-Positive association';
      explanation = 'Somewhat faster when Manmohan paired with positive words.';
    }
    
    const csv = iatData.csv();
    
    EXPERIMENT_DATA = {
      id: PID,
      date: new Date().toLocaleString(),
      device: IS_MOBILE ? 'Mobile' : 'Desktop',
      trials: total,
      accuracy: accuracy + '%',
      rt: meanRT + 'ms',
      dscore: dScore.toFixed(3),
      result: interpretation,
      explanation: explanation,
      csv: csv
    };
    
    console.log('‚úÖ DATA READY:', EXPERIMENT_DATA);
    showResults();
  },
  
  on_data_update: function(data) {
    data.participant_id = PID;
    data.device = IS_MOBILE ? 'mobile' : 'desktop';
    data.timestamp = new Date().toISOString();
  }
});

// ===========================================
// RESULTS DISPLAY
// ===========================================
function showResults() {
  document.getElementById('experiment').innerHTML = `
    <div class="container">
      <div class="box">
        <h1>‚úÖ Experiment Complete!</h1>
        <p>Thank you for participating.</p>
        
        <div class="success">
          <strong>Your data is ready to download.</strong>
        </div>
        
        <div style="background: #f8f9fa; padding: 18px; border-radius: 8px; margin: 18px 0;">
          <div class="result-item"><strong>ID:</strong> ${EXPERIMENT_DATA.id}</div>
          <div class="result-item"><strong>Date:</strong> ${EXPERIMENT_DATA.date}</div>
          <div class="result-item"><strong>Device:</strong> ${EXPERIMENT_DATA.device}</div>
          <div class="result-item"><strong>Trials:</strong> ${EXPERIMENT_DATA.trials}</div>
          <div class="result-item"><strong>Accuracy:</strong> ${EXPERIMENT_DATA.accuracy}</div>
          <div class="result-item"><strong>Avg RT:</strong> ${EXPERIMENT_DATA.rt}</div>
          <div class="result-item" style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #ddd;">
            <strong>D-Score:</strong> ${EXPERIMENT_DATA.dscore}
          </div>
          <div class="result-item"><strong>Result:</strong> ${EXPERIMENT_DATA.result}</div>
          <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; font-size: 14px;">
            ${EXPERIMENT_DATA.explanation}
          </div>
        </div>
        
        <div class="warning">
          <strong>‚ö†Ô∏è IMPORTANT:</strong> Download and send your data to the researcher!
        </div>
        
        <button class="btn" onclick="downloadBoth()">üì• Download All Data</button>
        <button class="btn" onclick="downloadCSV()">üìä Download CSV</button>
        <button class="btn" onclick="downloadSummary()">üìÑ Download Summary</button>
      </div>
    </div>
  `;
}

// ===========================================
// TIMELINE
// ===========================================
const timeline = [];

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Implicit Association Test</h1>
        <p><strong>Political Attitudes Study</strong></p>
        <p>Measures automatic associations between political figures and positive/negative words.</p>
        
        <div style="margin: 18px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <p><strong>You will see:</strong></p>
          <p>‚Ä¢ Photos of Narendra Modi<br>
          ‚Ä¢ Photos of Dr. Manmohan Singh<br>
          ‚Ä¢ Positive words<br>
          ‚Ä¢ Negative words</p>
        </div>
        
        <div class="warning">
          <strong>Duration:</strong> 5-7 minutes<br>
          <strong>Respond as fast as possible!</strong>
        </div>
        
        <p style="text-align: center; font-weight: 700; margin-top: 25px; font-size: 18px;">
          ${IS_MOBILE ? 'üëá TAP CONTINUE BELOW üëá' : 'PRESS ANY KEY'}
        </p>
      </div>
    </div>
  `,
  on_load: () => {
    if (IS_MOBILE) {
      console.log('üì± WELCOME SCREEN - SHOWING CONTROLS');
      setupTouchControls('single', 'CONTINUE');
    }
  },
  on_finish: () => hideTouchControls()
});

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Instructions</h1>
        <p>Use ${IS_MOBILE ? '<strong>the E and I buttons below</strong>' : '<strong>E and I keys</strong>'} to categorize items.</p>
        
        <div class="cats">
          <div class="cat">E<br>Left</div>
          <div class="cat">I<br>Right</div>
        </div>
        
        <div class="warning">
          <strong>If wrong:</strong> An ‚úï appears. Press ${IS_MOBILE ? 'the other button' : 'the correct key'}.
        </div>
        
        <p style="text-align: center; font-weight: 700; margin-top: 25px; font-size: 18px;">
          ${IS_MOBILE ? 'üëá TAP BEGIN BELOW üëá' : 'PRESS SPACE'}
        </p>
      </div>
    </div>
  `,
  choices: [' '],
  on_load: () => {
    if (IS_MOBILE) {
      console.log('üì± INSTRUCTIONS - SHOWING CONTROLS');
      setupTouchControls('single', 'BEGIN');
    }
  },
  on_finish: () => hideTouchControls()
});

function blockIntro(title, left, right, reversed) {
  return {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div class="container">
        <div class="box">
          <h1>${title}</h1>
          ${reversed ? '<div class="warning"><strong>‚ö†Ô∏è SIDES SWITCHED!</strong></div>' : ''}
          <div class="cats">
            <div class="cat">E<br>${left}</div>
            <div class="cat">I<br>${right}</div>
          </div>
          <p style="text-align: center; font-weight: 700; margin-top: 25px; font-size: 18px;">
            ${IS_MOBILE ? 'üëá TAP START BELOW üëá' : 'PRESS SPACE'}
          </p>
        </div>
      </div>
    `,
    choices: [' '],
    on_load: () => {
      if (IS_MOBILE) {
        console.log('üì± BLOCK INTRO - SHOWING CONTROLS');
        setupTouchControls('single', 'START');
      }
    },
    on_finish: () => hideTouchControls()
  };
}

function imgTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatImage,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'image', critical: crit || false},
    on_load: () => {
      if (IS_MOBILE) {
        console.log('üì± IMAGE TRIAL - SHOWING CONTROLS');
        setupTouchControls('double', {e: lShort, i: rShort});
      }
    }
  };
}

function wordTrial(block, lCat, rCat, lShort, rShort, crit) {
  return {
    type: jsPsychIatHtml,
    stimulus: jsPsych.timelineVariable('stim'),
    stim_key_association: jsPsych.timelineVariable('side'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${lCat} | I = ${rCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: lCat.split('/'),
    right_category_label: rCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'word', critical: crit || false},
    on_load: () => {
      if (IS_MOBILE) {
        console.log('üì± WORD TRIAL - SHOWING CONTROLS');
        setupTouchControls('double', {e: lShort, i: rShort});
      }
    }
  };
}

// BLOCK 1
timeline.push(blockIntro('Categorize Leaders', 'Modi', 'Manmohan', false));
timeline.push({
  timeline: [imgTrial('practice1', 'Modi', 'Manmohan', 'Modi', 'Manmohan')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 2
});

// BLOCK 2
timeline.push(blockIntro('Categorize Words', 'Positive', 'Negative', false));
timeline.push({
  timeline: [wordTrial('practice2', 'Positive', 'Negative', 'Positive', 'Negative')],
  timeline_variables: [
    ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
    ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 3
timeline.push(blockIntro('Combined', 'Modi or Positive', 'Manmohan or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 4 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'left'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// BLOCK 5
timeline.push(blockIntro('Categorize Leaders', 'Manmohan', 'Modi', true));
timeline.push({
  timeline: [imgTrial('practice4', 'Manmohan', 'Modi', 'Manmohan', 'Modi')],
  timeline_variables: [
    ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
    ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
  ],
  randomize_order: true,
  repetitions: 5
});

// BLOCK 6
timeline.push(blockIntro('Combined', 'Manmohan or Positive', 'Modi or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 7 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...IMG_MODI.map(img => ({stim: img, side: 'right'})),
        ...IMG_MANMOHAN.map(img => ({stim: img, side: 'left'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...WORDS_POS.map(w => ({stim: w, side: 'left'})),
        ...WORDS_NEG.map(w => ({stim: w, side: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="container">
      <div class="box">
        <h1>Almost Done!</h1>
        <p>You completed all trials.</p>
        <div class="success">
          The IAT measures automatic associations by comparing response times.
        </div>
        <p style="text-align: center; font-weight: 700; margin-top: 25px; font-size: 18px;">
          ${IS_MOBILE ? 'üëá TAP FOR RESULTS üëá' : 'PRESS ANY KEY'}
        </p>
      </div>
    </div>
  `,
  on_load: () => {
    if (IS_MOBILE) {
      console.log('üì± DEBRIEF - SHOWING CONTROLS');
      setupTouchControls('single', 'VIEW RESULTS');
    }
  },
  on_finish: () => hideTouchControls()
});

// START
console.log('üöÄ STARTING EXPERIMENT');
jsPsych.run(timeline);
</script>
</html>
