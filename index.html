<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prime Minister Popularity IAT</title>

    <!-- jsPsych core -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    
    <!-- jsPsych plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>

    <!-- jsPsych stylesheet -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
    
    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      body {
        margin: 0;
        padding: 10px;
        background-color: #f5f5f5;
        touch-action: manipulation;
      }
      
      .instructions-text {
        font-size: 18px;
        max-width: 900px;
        margin: auto;
        text-align: left;
        line-height: 1.6;
        padding: 10px;
      }
      
      .category-label {
        padding: 15px;
        margin: 10px;
        background-color: #e0e0e0;
        border-radius: 8px;
        font-weight: bold;
      }

      /* Mobile touch buttons - FIXED POSITION */
      .touch-response-buttons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.98);
        border-top: 3px solid #333;
        z-index: 9999;
        box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
      }

      .touch-btn {
        flex: 1;
        padding: 25px 15px;
        font-size: 20px;
        font-weight: bold;
        border: 3px solid #333;
        border-radius: 12px;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        transition: all 0.1s;
        text-align: center;
      }

      .touch-btn:active {
        transform: scale(0.95);
        opacity: 0.8;
      }

      .touch-btn-left {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .touch-btn-right {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
      }

      .touch-btn-continue {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: #000;
        font-size: 22px;
      }

      /* IAT trial modifications for mobile */
      .jspsych-iat-stim {
        margin-bottom: 150px !important;
      }

      .jspsych-content {
        margin-bottom: 150px;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .instructions-text {
          font-size: 16px;
        }
        
        .instructions-text h1 {
          font-size: 24px;
        }
        
        .instructions-text h2 {
          font-size: 20px;
        }
        
        .category-label {
          padding: 10px;
          margin: 5px;
          font-size: 14px;
        }

        .touch-btn {
          padding: 20px 10px;
          font-size: 18px;
        }
      }

      @media (max-width: 480px) {
        .touch-btn {
          padding: 18px 8px;
          font-size: 16px;
        }

        .instructions-text {
          font-size: 14px;
        }
      }
    </style>
  </head>

  <body></body>

  <script>
    // Mobile detection
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
    
    console.log('Is Mobile:', isMobile);

    // Initialize jsPsych
    const jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData('csv');
      }
    });

    // Create timeline
    const timeline = [];

    // MOBILE: Welcome screen with button
    if (isMobile) {
      const welcome = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div style="font-size: 20px; max-width: 800px; margin: auto; text-align: center; padding-bottom: 100px;">
            <h1>Prime Minister Popularity IAT</h1>
            <p>Welcome to this research study on implicit attitudes.</p>
            <p>In this task, you will categorize photos of Prime Ministers and words.</p>
            <p>The task takes approximately 5-7 minutes.</p>
            <br>
            <p><strong>Tap the button below to continue.</strong></p>
          </div>
        `,
        choices: ['CONTINUE'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #ffc107; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(welcome);
    } else {
      // DESKTOP: Welcome screen with keyboard
      const welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="font-size: 24px; max-width: 800px; margin: auto; text-align: center;">
            <h1>Prime Minister Popularity IAT</h1>
            <p>Welcome to this research study on implicit attitudes.</p>
            <p>In this task, you will categorize photos of Prime Ministers and words.</p>
            <p>The task takes approximately 5-7 minutes.</p>
            <br>
            <p><strong>Press any key to continue.</strong></p>
          </div>
        `
      };
      timeline.push(welcome);
    }

    // MOBILE: Instructions with button
    if (isMobile) {
      const instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="instructions-text" style="padding-bottom: 100px;">
            <h2>Instructions</h2>
            
            <p>In this experiment, you will be shown:</p>
            <ul>
              <li>Photos of <strong>Narendra Modi</strong></li>
              <li>Photos of <strong>Previous Prime Ministers</strong></li>
              <li><strong>Positive</strong> words (e.g., "Lovely", "Joyous")</li>
              <li><strong>Negative</strong> words (e.g., "Nasty", "Pain")</li>
            </ul>

            <div style="margin: 20px 0; padding: 20px; background-color: #fff3cd; border-radius: 10px; border: 2px solid #ffc107;">
              <h3>Your Task:</h3>
              <p>Use the <strong>LEFT</strong> and <strong>RIGHT</strong> buttons at the bottom to categorize items as quickly and accurately as possible.</p>
              <p>The categories will appear at the top of the screen.</p>
            </div>

            <p><strong>If you make an error:</strong> A red X will appear. Simply tap the other button to continue.</p>
            
            <p><strong>Important:</strong> Respond as quickly as you can while making as few errors as possible.</p>
            
            <br>
            <p style="text-align: center;"><strong>Tap START when ready to begin.</strong></p>
          </div>
        `,
        choices: ['START'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #28a745; color: white; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(instructions);
    } else {
      // DESKTOP: Instructions with keyboard
      const instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="instructions-text">
            <h2>Instructions</h2>
            
            <p>In this experiment, you will be shown:</p>
            <ul>
              <li>Photos of <strong>Narendra Modi</strong></li>
              <li>Photos of <strong>Previous Prime Ministers</strong></li>
              <li><strong>Positive</strong> words (e.g., "Lovely", "Joyous")</li>
              <li><strong>Negative</strong> words (e.g., "Nasty", "Pain")</li>
            </ul>

            <div style="margin: 30px 0; padding: 25px; background-color: #fff3cd; border-radius: 10px; border: 2px solid #ffc107;">
              <h3>Your Task:</h3>
              <p>Use the <strong>E</strong> and <strong>I</strong> keys to categorize items as quickly and accurately as possible.</p>
              <p>The categories that share a response key will appear at the top of the screen.</p>
            </div>

            <p><strong>If you make an error:</strong> A red X will appear. Simply press the other key to continue.</p>
            
            <p><strong>Important:</strong> Respond as quickly as you can while making as few errors as possible.</p>
            
            <br>
            <p style="text-align: center;"><strong>Press SPACEBAR when ready to begin.</strong></p>
          </div>
        `,
        choices: [' ']
      };
      timeline.push(instructions);
    }

    // Define image stimuli - FIXED FILE EXTENSIONS
    const modi_images = [
      'imagesmodi1.jpeg.jpeg',
      'imagesmodi2.jpeg.jpeg',
      'imagesmodi3.jpeg.jpeg',
      'imagesmodi4.jpeg.jpeg'
    ];

    const previous_pm_images = [
      'imagesprevious1.jpeg.jpeg',
      'imagesprevious2.jpeg.jpeg',
      'imagesprevious3.jpeg.jpeg',
      'imagesprevious4.jpeg.jpeg'
    ];

    // Define word stimuli
    const positive_words = [
      'Delightful', 'Enjoy', 'Joyous', 'Lovely', 
      'Pleasing', 'Glorious', 'Laughter', 'Beautiful', 'Spectacular'
    ];

    const negative_words = [
      'Yucky', 'Disgust', 'Humiliate', 'Tragic', 'Nasty', 
      'Failure', 'Agony', 'Pain', 'Rotten'
    ];

    // Helper function to add touch buttons
    function addTouchButtons(leftLabel, rightLabel) {
      if (!isMobile) return;
      
      setTimeout(() => {
        const existing = document.querySelector('.touch-response-buttons');
        if (existing) existing.remove();

        const btnContainer = document.createElement('div');
        btnContainer.className = 'touch-response-buttons';
        
        const leftBtn = document.createElement('button');
        leftBtn.className = 'touch-btn touch-btn-left';
        leftBtn.innerHTML = `<div style="font-size: 24px; margin-bottom: 5px;">E</div><div>${leftLabel}</div>`;
        leftBtn.onclick = () => {
          document.dispatchEvent(new KeyboardEvent('keydown', {key: 'e', keyCode: 69, which: 69, bubbles: true}));
        };
        
        const rightBtn = document.createElement('button');
        rightBtn.className = 'touch-btn touch-btn-right';
        rightBtn.innerHTML = `<div style="font-size: 24px; margin-bottom: 5px;">I</div><div>${rightLabel}</div>`;
        rightBtn.onclick = () => {
          document.dispatchEvent(new KeyboardEvent('keydown', {key: 'i', keyCode: 73, which: 73, bubbles: true}));
        };
        
        btnContainer.appendChild(leftBtn);
        btnContainer.appendChild(rightBtn);
        document.body.appendChild(btnContainer);
      }, 100);
    }

    function addContinueButton() {
      if (!isMobile) return;
      
      setTimeout(() => {
        const existing = document.querySelector('.touch-response-buttons');
        if (existing) existing.remove();

        const btnContainer = document.createElement('div');
        btnContainer.className = 'touch-response-buttons';
        
        const continueBtn = document.createElement('button');
        continueBtn.className = 'touch-btn touch-btn-continue';
        continueBtn.textContent = 'CONTINUE';
        continueBtn.onclick = () => {
          document.dispatchEvent(new KeyboardEvent('keydown', {key: ' ', keyCode: 32, which: 32, bubbles: true}));
        };
        
        btnContainer.appendChild(continueBtn);
        document.body.appendChild(btnContainer);
      }, 100);
    }

    function removeTouchButtons() {
      if (!isMobile) return;
      const existing = document.querySelector('.touch-response-buttons');
      if (existing) existing.remove();
    }

    // Block 1: Practice categorizing PMs
    if (isMobile) {
      const pm_practice_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center; padding-bottom: 100px;">
            <h2>Practice: Categorize Prime Ministers</h2>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 600px; margin: 20px auto; flex-wrap: wrap;">
              <div class="category-label" style="background: #d4edda;">
                <p><strong>LEFT Button (E)</strong></p>
                <h3>Narendra Modi</h3>
              </div>
              <div class="category-label" style="background: #f8d7da;">
                <p><strong>RIGHT Button (I)</strong></p>
                <h3>Previous PMs</h3>
              </div>
            </div>
            <br>
            <p><strong>Tap START to begin.</strong></p>
          </div>
        `,
        choices: ['START'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #28a745; color: white; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(pm_practice_instructions);
    } else {
      const pm_practice_instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center;">
            <h2>Practice: Categorize Prime Ministers</h2>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 600px; margin: 30px auto;">
              <div class="category-label">
                <p>Press <strong>E</strong> for:</p>
                <h3>Narendra Modi</h3>
              </div>
              <div class="category-label">
                <p>Press <strong>I</strong> for:</p>
                <h3>Previous PMs</h3>
              </div>
            </div>
            <br>
            <p><strong>Press SPACEBAR to start.</strong></p>
          </div>
        `,
        choices: [' ']
      };
      timeline.push(pm_practice_instructions);
    }

    const pm_practice = {
      type: jsPsychIatImage,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Modi</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Previous PMs</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Narendra Modi'],
      right_category_label: ['Previous PMs'],
      response_ends_trial: true,
      stimulus_width: isMobile ? 280 : 400,
      on_load: () => addTouchButtons('Modi', 'Previous PMs'),
      on_finish: () => removeTouchButtons()
    };

    const pm_practice_procedure = {
      timeline: [pm_practice],
      timeline_variables: [
        ...modi_images.map(img => ({stimulus: img, stim_key_association: 'left'})),
        ...previous_pm_images.map(img => ({stimulus: img, stim_key_association: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    };
    timeline.push(pm_practice_procedure);

    // Block 2: Practice categorizing words
    if (isMobile) {
      const word_practice_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center; padding-bottom: 100px;">
            <h2>Practice: Categorize Words</h2>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 600px; margin: 20px auto; flex-wrap: wrap;">
              <div class="category-label" style="background: #d4edda;">
                <p><strong>LEFT Button (E)</strong></p>
                <h3>Positive</h3>
              </div>
              <div class="category-label" style="background: #f8d7da;">
                <p><strong>RIGHT Button (I)</strong></p>
                <h3>Negative</h3>
              </div>
            </div>
            <br>
            <p><strong>Tap START to begin.</strong></p>
          </div>
        `,
        choices: ['START'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #28a745; color: white; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(word_practice_instructions);
    } else {
      const word_practice_instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center;">
            <h2>Practice: Categorize Words</h2>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 600px; margin: 30px auto;">
              <div class="category-label">
                <p>Press <strong>E</strong> for:</p>
                <h3>Positive</h3>
              </div>
              <div class="category-label">
                <p>Press <strong>I</strong> for:</p>
                <h3>Negative</h3>
              </div>
            </div>
            <br>
            <p><strong>Press SPACEBAR to start.</strong></p>
          </div>
        `,
        choices: [' ']
      };
      timeline.push(word_practice_instructions);
    }

    const word_practice = {
      type: jsPsychIatHtml,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Positive'],
      right_category_label: ['Negative'],
      response_ends_trial: true,
      on_load: () => addTouchButtons('Positive', 'Negative'),
      on_finish: () => removeTouchButtons()
    };

    const word_practice_procedure = {
      timeline: [word_practice],
      timeline_variables: [
        ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
        ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
      ],
      randomize_order: true,
      repetitions: 1
    };
    timeline.push(word_practice_procedure);

    // Block 3: Combined practice
    if (isMobile) {
      const combined1_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center; padding-bottom: 100px;">
            <h2>Combined Task</h2>
            <p>Now combine both tasks. Use the same buttons for both photos and words.</p>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 700px; margin: 20px auto; flex-wrap: wrap;">
              <div class="category-label" style="background-color: #d4edda;">
                <p><strong>LEFT (E)</strong></p>
                <h3>Modi OR Positive</h3>
              </div>
              <div class="category-label" style="background-color: #f8d7da;">
                <p><strong>RIGHT (I)</strong></p>
                <h3>Previous PMs OR Negative</h3>
              </div>
            </div>
            <br>
            <p><strong>Tap START to begin.</strong></p>
          </div>
        `,
        choices: ['START'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #28a745; color: white; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(combined1_instructions);
    } else {
      const combined1_instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center;">
            <h2>Combined Task</h2>
            <p>Now combine both tasks. Use the same keys for both photos and words.</p>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 700px; margin: 30px auto;">
              <div class="category-label" style="background-color: #d4edda;">
                <p>Press <strong>E</strong> for:</p>
                <h3>Narendra Modi</h3>
                <h3>OR</h3>
                <h3>Positive</h3>
              </div>
              <div class="category-label" style="background-color: #f8d7da;">
                <p>Press <strong>I</strong> for:</p>
                <h3>Previous PMs</h3>
                <h3>OR</h3>
                <h3>Negative</h3>
              </div>
            </div>
            <br>
            <p><strong>Press SPACEBAR to start.</strong></p>
          </div>
        `,
        choices: [' ']
      };
      timeline.push(combined1_instructions);
    }

    const combined1_practice_images = {
      type: jsPsychIatImage,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Modi/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Previous/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Modi', 'Positive'],
      right_category_label: ['Previous PMs', 'Negative'],
      response_ends_trial: true,
      stimulus_width: isMobile ? 280 : 400,
      on_load: () => addTouchButtons('Modi/Positive', 'Previous/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined1_practice_words = {
      type: jsPsychIatHtml,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Modi/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Previous/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Modi', 'Positive'],
      right_category_label: ['Previous PMs', 'Negative'],
      response_ends_trial: true,
      on_load: () => addTouchButtons('Modi/Positive', 'Previous/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined1_practice_procedure = {
      timeline: [
        {
          timeline: [combined1_practice_images],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'left'})),
            ...previous_pm_images.map(img => ({stimulus: img, stim_key_association: 'right'}))
          ],
          randomize_order: true
        },
        {
          timeline: [combined1_practice_words],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true
        }
      ],
      randomize_order: true,
      repetitions: 1
    };
    timeline.push(combined1_practice_procedure);

    // Block 4: Combined TEST
    const combined1_test_images = {
      type: jsPsychIatImage,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Modi/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Previous/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Modi', 'Positive'],
      right_category_label: ['Previous PMs', 'Negative'],
      response_ends_trial: true,
      stimulus_width: isMobile ? 280 : 400,
      data: {block: 'compatible', item_type: 'image'},
      on_load: () => addTouchButtons('Modi/Positive', 'Previous/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined1_test_words = {
      type: jsPsychIatHtml,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Modi/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Previous/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Modi', 'Positive'],
      right_category_label: ['Previous PMs', 'Negative'],
      response_ends_trial: true,
      data: {block: 'compatible', item_type: 'word'},
      on_load: () => addTouchButtons('Modi/Positive', 'Previous/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined1_test_procedure = {
      timeline: [
        {
          timeline: [combined1_test_images],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'left'})),
            ...previous_pm_images.map(img => ({stimulus: img, stim_key_association: 'right'}))
          ],
          randomize_order: true,
          repetitions: 2
        },
        {
          timeline: [combined1_test_words],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true,
          repetitions: 2
        }
      ],
      randomize_order: true
    };
    timeline.push(combined1_test_procedure);

    // Block 5: Reversed PM categorization
    if (isMobile) {
      const pm_reversed_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center; padding-bottom: 100px;">
            <h2 style="color: #d9534f;">⚠️ CATEGORIES REVERSED!</h2>
            <p style="font-size: 20px;">The categories have switched sides.</p>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 600px; margin: 20px auto; flex-wrap: wrap;">
              <div class="category-label" style="background-color: #fff3cd; border: 3px solid #ffc107;">
                <p><strong>LEFT (E)</strong></p>
                <h3>Previous PMs</h3>
              </div>
              <div class="category-label" style="background-color: #fff3cd; border: 3px solid #ffc107;">
                <p><strong>RIGHT (I)</strong></p>
                <h3>Narendra Modi</h3>
              </div>
            </div>
            <br>
            <p><strong>Tap START to begin.</strong></p>
          </div>
        `,
        choices: ['START'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #ffc107; color: #000; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(pm_reversed_instructions);
    } else {
      const pm_reversed_instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center;">
            <h2 style="color: #d9534f;">ATTENTION: Categories Reversed!</h2>
            <p style="font-size: 22px;">The categories have switched sides.</p>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 600px; margin: 30px auto;">
              <div class="category-label" style="background-color: #fff3cd; border: 3px solid #ffc107;">
                <p>Press <strong>E</strong> for:</p>
                <h3>Previous PMs</h3>
              </div>
              <div class="category-label" style="background-color: #fff3cd; border: 3px solid #ffc107;">
                <p>Press <strong>I</strong> for:</p>
                <h3>Narendra Modi</h3>
              </div>
            </div>
            <br>
            <p><strong>Press SPACEBAR to start.</strong></p>
          </div>
        `,
        choices: [' ']
      };
      timeline.push(pm_reversed_instructions);
    }

    const pm_reversed_practice = {
      type: jsPsychIatImage,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Previous PMs</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Modi</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Previous PMs'],
      right_category_label: ['Narendra Modi'],
      response_ends_trial: true,
      stimulus_width: isMobile ? 280 : 400,
      on_load: () => addTouchButtons('Previous PMs', 'Modi'),
      on_finish: () => removeTouchButtons()
    };

    const pm_reversed_practice_procedure = {
      timeline: [pm_reversed_practice],
      timeline_variables: [
        ...modi_images.map(img => ({stimulus: img, stim_key_association: 'right'})),
        ...previous_pm_images.map(img => ({stimulus: img, stim_key_association: 'left'}))
      ],
      randomize_order: true,
      repetitions: 2
    };
    timeline.push(pm_reversed_practice_procedure);

    // Block 6: Combined practice REVERSED
    if (isMobile) {
      const combined2_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center; padding-bottom: 100px;">
            <h2>Combined Task - Reversed</h2>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 700px; margin: 20px auto; flex-wrap: wrap;">
              <div class="category-label" style="background-color: #d4edda;">
                <p><strong>LEFT (E)</strong></p>
                <h3>Previous PMs OR Positive</h3>
              </div>
              <div class="category-label" style="background-color: #f8d7da;">
                <p><strong>RIGHT (I)</strong></p>
                <h3>Modi OR Negative</h3>
              </div>
            </div>
            <br>
            <p><strong>Tap START to begin.</strong></p>
          </div>
        `,
        choices: ['START'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #28a745; color: white; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(combined2_instructions);
    } else {
      const combined2_instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="instructions-text" style="text-align: center;">
            <h2>Combined Task - Reversed</h2>
            <br>
            <div style="display: flex; justify-content: space-around; max-width: 700px; margin: 30px auto;">
              <div class="category-label" style="background-color: #d4edda;">
                <p>Press <strong>E</strong> for:</p>
                <h3>Previous PMs</h3>
                <h3>OR</h3>
                <h3>Positive</h3>
              </div>
              <div class="category-label" style="background-color: #f8d7da;">
                <p>Press <strong>I</strong> for:</p>
                <h3>Narendra Modi</h3>
                <h3>OR</h3>
                <h3>Negative</h3>
              </div>
            </div>
            <br>
            <p><strong>Press SPACEBAR to start.</strong></p>
          </div>
        `,
        choices: [' ']
      };
      timeline.push(combined2_instructions);
    }

    const combined2_practice_images = {
      type: jsPsychIatImage,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Previous/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Modi/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Previous PMs', 'Positive'],
      right_category_label: ['Modi', 'Negative'],
      response_ends_trial: true,
      stimulus_width: isMobile ? 280 : 400,
      on_load: () => addTouchButtons('Previous/Positive', 'Modi/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined2_practice_words = {
      type: jsPsychIatHtml,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Previous/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Modi/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Previous PMs', 'Positive'],
      right_category_label: ['Modi', 'Negative'],
      response_ends_trial: true,
      on_load: () => addTouchButtons('Previous/Positive', 'Modi/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined2_practice_procedure = {
      timeline: [
        {
          timeline: [combined2_practice_images],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'right'})),
            ...previous_pm_images.map(img => ({stimulus: img, stim_key_association: 'left'}))
          ],
          randomize_order: true
        },
        {
          timeline: [combined2_practice_words],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true
        }
      ],
      randomize_order: true,
      repetitions: 1
    };
    timeline.push(combined2_practice_procedure);

    // Block 7: Combined TEST REVERSED
    const combined2_test_images = {
      type: jsPsychIatImage,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Previous/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Modi/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Previous PMs', 'Positive'],
      right_category_label: ['Modi', 'Negative'],
      response_ends_trial: true,
      stimulus_width: isMobile ? 280 : 400,
      data: {block: 'incompatible', item_type: 'image'},
      on_load: () => addTouchButtons('Previous/Positive', 'Modi/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined2_test_words = {
      type: jsPsychIatHtml,
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_key_association: jsPsych.timelineVariable('stim_key_association'),
      html_when_wrong: '<span style="color: red; font-size: 80px; font-weight: bold;">X</span>',
      bottom_instructions: `<p>${isMobile ? 'LEFT' : 'E'} = <strong>Previous/Positive</strong> | ${isMobile ? 'RIGHT' : 'I'} = <strong>Modi/Negative</strong></p>`,
      force_correct_key_press: true,
      display_feedback: true,
      trial_duration: 3000,
      left_category_key: 'e',
      right_category_key: 'i',
      left_category_label: ['Previous PMs', 'Positive'],
      right_category_label: ['Modi', 'Negative'],
      response_ends_trial: true,
      data: {block: 'incompatible', item_type: 'word'},
      on_load: () => addTouchButtons('Previous/Positive', 'Modi/Negative'),
      on_finish: () => removeTouchButtons()
    };

    const combined2_test_procedure = {
      timeline: [
        {
          timeline: [combined2_test_images],
          timeline_variables: [
            ...modi_images.map(img => ({stimulus: img, stim_key_association: 'right'})),
            ...previous_pm_images.map(img => ({stimulus: img, stim_key_association: 'left'}))
          ],
          randomize_order: true,
          repetitions: 2
        },
        {
          timeline: [combined2_test_words],
          timeline_variables: [
            ...positive_words.map(word => ({stimulus: word, stim_key_association: 'left'})),
            ...negative_words.map(word => ({stimulus: word, stim_key_association: 'right'}))
          ],
          randomize_order: true,
          repetitions: 2
        }
      ],
      randomize_order: true
    };
    timeline.push(combined2_test_procedure);

    // Debrief
    if (isMobile) {
      const debrief = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div style="font-size: 18px; max-width: 800px; margin: auto; padding: 20px 10px 120px 10px;">
            <h1>Thank You for Participating!</h1>
            
            <p>The experiment is complete.</p>
            
            <h3>About This Study:</h3>
            <p>This was an Implicit Association Test (IAT) measuring automatic associations 
            between Prime Ministers and positive/negative words.</p>
            
            <p>The IAT measures the strength of associations between concepts 
            (like "Modi" and "Previous PMs") and evaluations (like "Positive" and "Negative").</p>
            
            <p><strong>Your data will be displayed on the next screen.</strong></p>
            
            <p>Tap VIEW RESULTS to see your data.</p>
          </div>
        `,
        choices: ['VIEW RESULTS'],
        button_html: '<button class="jspsych-btn" style="font-size: 22px; padding: 20px 40px; background: #007bff; color: white; border: 3px solid #000; border-radius: 10px; font-weight: bold;">%choice%</button>'
      };
      timeline.push(debrief);
    } else {
      const debrief = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="font-size: 20px; max-width: 800px; margin: auto;">
            <h1>Thank You for Participating!</h1>
            
            <p>The experiment is complete.</p>
            
            <h3>About This Study:</h3>
            <p>This was an Implicit Association Test (IAT) measuring automatic associations 
            between Prime Ministers and positive/negative words.</p>
            
            <p>The IAT measures the strength of associations between concepts 
            (like "Modi" and "Previous PMs") and evaluations (like "Positive" and "Negative").</p>
            
            <p><strong>Your data will be displayed on the next screen.</strong></p>
            
            <p>Press any key to see your results.</p>
          </div>
        `
      };
      timeline.push(debrief);
    }

    // Run the experiment
    jsPsych.run(timeline);
  </script>
</html>
