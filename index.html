<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>IAT Study</title>

  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    
    html, body {
      width: 100%;
      height: 100%;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      color: #1a1a1a;
      font-size: 16px;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    
    body {
      padding-bottom: 120px;
      padding-bottom: calc(120px + env(safe-area-inset-bottom));
    }
    
    .page {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 30px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    h1 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #1a1a1a;
    }
    
    h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 24px 0 12px;
      color: #1a1a1a;
    }
    
    p {
      font-size: 16px;
      line-height: 1.6;
      color: #4a4a4a;
      margin-bottom: 12px;
    }
    
    .label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
      margin-bottom: 8px;
    }
    
    .cats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }
    
    .cat {
      background: #1a1a1a;
      color: white;
      border-radius: 8px;
      padding: 20px 16px;
      text-align: center;
    }
    
    .cat-key {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      opacity: 0.7;
      margin-bottom: 6px;
    }
    
    .cat-label {
      font-size: 15px;
      font-weight: 600;
    }
    
    .alert {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }
    
    .alert p {
      color: #856404;
      margin: 0;
    }
    
    .success {
      background: #d4edda;
      border-color: #28a745;
    }
    
    .success p {
      color: #155724;
    }
    
    /* MOBILE CONTROLS */
    #mobile-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 2px solid #e0e0e0;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      display: none;
      gap: 10px;
      z-index: 999999;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    }
    
    #mobile-controls.show {
      display: flex;
    }
    
    .mob-btn {
      flex: 1;
      background: #1a1a1a;
      border: none;
      border-radius: 10px;
      padding: 20px 12px;
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }
    
    .mob-btn:active {
      background: #333;
      transform: scale(0.97);
    }
    
    .mob-btn-key {
      display: block;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .mob-btn-text {
      display: block;
      font-size: 11px;
      opacity: 0.8;
    }
    
    /* TRIAL DISPLAY */
    .jspsych-iat-stim {
      font-size: 40px !important;
      font-weight: 600 !important;
      color: #1a1a1a !important;
      margin: 60px auto !important;
      padding: 0 20px !important;
      text-align: center !important;
    }
    
    .jspsych-iat-stim img {
      max-width: 80vw !important;
      max-height: 40vh !important;
      height: auto !important;
      width: auto !important;
      border-radius: 8px;
      display: block !important;
      margin: 0 auto !important;
    }
    
    .error-mark {
      color: #dc3545 !important;
      font-size: 60px !important;
    }
    
    .jspsych-iat-category {
      font-family: inherit !important;
      font-weight: 600 !important;
      font-size: 13px !important;
      padding: 10px 16px !important;
      border: 2px solid #1a1a1a !important;
      border-radius: 6px !important;
      margin: 8px !important;
      background: white !important;
    }
    
    .jspsych-display-element > p {
      font-size: 13px !important;
      color: #666 !important;
      margin-top: 40px !important;
      padding: 0 20px 100px !important;
      text-align: center !important;
    }
    
    /* RESULTS */
    .result-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .result-box p {
      margin: 8px 0;
      font-size: 15px;
    }
    
    .result-box strong {
      color: #1a1a1a;
    }
    
    .divider {
      height: 1px;
      background: #e0e0e0;
      margin: 16px 0;
    }
    
    .btn {
      width: 100%;
      background: #1a1a1a;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 16px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 0;
      touch-action: manipulation;
    }
    
    .btn:active {
      background: #333;
    }
    
    @media (max-width: 600px) {
      .page {
        padding: 20px 16px;
      }
      
      .card {
        padding: 24px 20px;
      }
      
      h1 {
        font-size: 22px;
      }
      
      .jspsych-iat-stim {
        font-size: 36px !important;
        margin: 40px auto !important;
      }
    }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>
  <div id="mobile-controls"></div>
</body>

<script>
// ============================================
// CONFIGURATION
// ============================================
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 768;
const participantId = 'P' + Date.now();
let globalData = null;

console.log('üéØ IAT Started');
console.log('üì± Device:', isMobile ? 'Mobile' : 'Desktop');
console.log('üÜî ID:', participantId);

// ============================================
// IMAGES & WORDS
// ============================================
const MODI = [
  'imagesmodi1.jpg.jpeg',
  'imagesmodi2.jpg.jpeg',
  'imagesmodi3.jpg.jpeg',
  'imagesmodi4.jpg.jpeg'
];

const MANMOHAN = [
  'imagesprevious1.jpg.jpeg',
  'imagesprevious2.jpg.jpeg',
  'imagesprevious3.jpg.jpeg',
  'imagesprevious4.jpg.jpeg'
];

const POSITIVE = ['Wonderful', 'Happy', 'Joy', 'Love', 'Peace', 'Pleasure', 'Glorious', 'Laughter', 'Success', 'Hope'];
const NEGATIVE = ['Terrible', 'Awful', 'Horrible', 'Evil', 'Nasty', 'Failure', 'Agony', 'Pain', 'Disaster', 'Tragedy'];

// ============================================
// MOBILE CONTROLS
// ============================================
function showControls(type, labels) {
  const controls = document.getElementById('mobile-controls');
  if (!controls || !isMobile) return;
  
  controls.innerHTML = '';
  controls.className = 'show';
  
  if (type === 'continue') {
    const btn = document.createElement('button');
    btn.className = 'mob-btn';
    btn.innerHTML = `<span class="mob-btn-key">TAP</span><span class="mob-btn-text">${labels}</span>`;
    btn.onclick = () => triggerKey(' ');
    controls.appendChild(btn);
  } else {
    const btnE = document.createElement('button');
    btnE.className = 'mob-btn';
    btnE.innerHTML = `<span class="mob-btn-key">E</span><span class="mob-btn-text">${labels.left}</span>`;
    btnE.onclick = () => triggerKey('e');
    
    const btnI = document.createElement('button');
    btnI.className = 'mob-btn';
    btnI.innerHTML = `<span class="mob-btn-key">I</span><span class="mob-btn-text">${labels.right}</span>`;
    btnI.onclick = () => triggerKey('i');
    
    controls.appendChild(btnE);
    controls.appendChild(btnI);
  }
}

function hideControls() {
  const controls = document.getElementById('mobile-controls');
  if (controls) {
    controls.className = '';
    controls.innerHTML = '';
  }
}

function triggerKey(key) {
  const keyMap = {
    'e': {keyCode: 69, code: 'KeyE'},
    'i': {keyCode: 73, code: 'KeyI'},
    ' ': {keyCode: 32, code: 'Space'}
  };
  
  const info = keyMap[key];
  
  const down = new KeyboardEvent('keydown', {
    key: key,
    keyCode: info.keyCode,
    code: info.code,
    which: info.keyCode,
    bubbles: true,
    cancelable: true
  });
  
  document.dispatchEvent(down);
  
  setTimeout(() => {
    const up = new KeyboardEvent('keyup', {
      key: key,
      keyCode: info.keyCode,
      code: info.code,
      which: info.keyCode,
      bubbles: true,
      cancelable: true
    });
    document.dispatchEvent(up);
  }, 50);
}

// ============================================
// DOWNLOAD FUNCTIONS
// ============================================
function downloadCSV() {
  if (!globalData) {
    alert('No data available');
    return;
  }
  const blob = new Blob([globalData.csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `IAT_${globalData.id}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  alert('‚úÖ CSV downloaded! Send this file to the researcher.');
}

function downloadSummary() {
  if (!globalData) {
    alert('No data available');
    return;
  }
  const summary = `IAT RESULTS
============

Participant: ${globalData.id}
Date: ${globalData.date}
Device: ${globalData.device}

D-Score: ${globalData.dScore}
Result: ${globalData.result}
Accuracy: ${globalData.accuracy}
Mean RT: ${globalData.meanRT}
Total Trials: ${globalData.total}
`;
  
  const blob = new Blob([summary], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `IAT_Summary_${globalData.id}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  alert('‚úÖ Summary downloaded!');
}

function copyData() {
  if (!globalData) {
    alert('No data available');
    return;
  }
  const text = `IAT Results - ${globalData.id}
Date: ${globalData.date}
D-Score: ${globalData.dScore}
Result: ${globalData.result}
Accuracy: ${globalData.accuracy}
Mean RT: ${globalData.meanRT}`;
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      alert('‚úÖ Copied! Paste in WhatsApp/Email.');
    }).catch(() => {
      prompt('Copy this:', text);
    });
  } else {
    prompt('Copy this:', text);
  }
}

function shareWhatsApp() {
  if (!globalData) return;
  const text = `IAT Results%0A%0AID: ${globalData.id}%0ADate: ${globalData.date}%0AD-Score: ${globalData.dScore}%0AResult: ${globalData.result}%0AAccuracy: ${globalData.accuracy}%0AMean RT: ${globalData.meanRT}`;
  window.open(`https://wa.me/?text=${text}`, '_blank');
}

// ============================================
// JSPSYCH
// ============================================
const jsPsych = initJsPsych({
  display_element: 'jspsych-target',
  on_finish: function() {
    hideControls();
    
    console.log('üìä Processing data...');
    
    const allData = jsPsych.data.get();
    const iatData = allData.filter({trial_type: 'iat-image'}).union(allData.filter({trial_type: 'iat-html'}));
    
    const compat = iatData.filter({block: 'compatible', critical: true});
    const incompat = iatData.filter({block: 'incompatible', critical: true});
    
    const compatMean = compat.select('rt').mean();
    const incompatMean = incompat.select('rt').mean();
    const compatSD = compat.select('rt').sd();
    const incompatSD = incompat.select('rt').sd();
    const pooledSD = Math.sqrt((compatSD * compatSD + incompatSD * incompatSD) / 2);
    
    const dScore = (incompatMean - compatMean) / pooledSD;
    
    const correct = iatData.filter({correct: true}).count();
    const total = iatData.count();
    const accuracy = (correct / total * 100).toFixed(1);
    const meanRT = iatData.select('rt').mean().toFixed(0);
    
    let result = '';
    if (Math.abs(dScore) < 0.15) result = 'No clear preference';
    else if (dScore > 0.65) result = 'Strong Modi-Positive';
    else if (dScore > 0.35) result = 'Moderate Modi-Positive';
    else if (dScore > 0) result = 'Slight Modi-Positive';
    else if (dScore < -0.65) result = 'Strong Manmohan-Positive';
    else if (dScore < -0.35) result = 'Moderate Manmohan-Positive';
    else result = 'Slight Manmohan-Positive';
    
    const csv = iatData.csv();
    
    globalData = {
      id: participantId,
      device: isMobile ? 'mobile' : 'desktop',
      date: new Date().toLocaleString(),
      dScore: dScore.toFixed(3),
      result: result,
      accuracy: accuracy + '%',
      meanRT: meanRT + 'ms',
      total: total,
      csv: csv
    };
    
    console.log('‚úÖ Data ready:', globalData);
    
    // Display results
    document.getElementById('jspsych-target').innerHTML = `
      <div class="page">
        <div class="card">
          <h1>‚úÖ Experiment Complete!</h1>
          <p>Thank you for participating.</p>
          
          <div class="result-box">
            <p><strong>Participant ID:</strong> ${globalData.id}</p>
            <p><strong>Date:</strong> ${globalData.date}</p>
            <p><strong>Device:</strong> ${globalData.device}</p>
            <div class="divider"></div>
            <p><strong>Trials:</strong> ${globalData.total}</p>
            <p><strong>Accuracy:</strong> ${globalData.accuracy}</p>
            <p><strong>Avg RT:</strong> ${globalData.meanRT}</p>
            <div class="divider"></div>
            <p><strong>D-Score:</strong> ${globalData.dScore}</p>
            <p><strong>Result:</strong> ${globalData.result}</p>
          </div>
          
          <div class="alert">
            <p><strong>üì§ Send your data to the researcher!</strong></p>
          </div>
          
          <button class="btn" onclick="downloadCSV()">üì• Download CSV Data</button>
          <button class="btn" onclick="downloadSummary()">üìÑ Download Summary</button>
          <button class="btn" onclick="copyData()">üìã Copy to Clipboard</button>
          <button class="btn" onclick="shareWhatsApp()">üí¨ Share via WhatsApp</button>
        </div>
      </div>
    `;
  },
  on_data_update: function(data) {
    data.participant_id = participantId;
    data.device = isMobile ? 'mobile' : 'desktop';
  }
});

// ============================================
// TIMELINE
// ============================================
const timeline = [];

// Welcome
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="page">
      <div class="card">
        <div class="label">Research Study</div>
        <h1>Implicit Association Test</h1>
        <p>This study measures automatic associations between political figures and evaluative words.</p>
        <h2>You will see:</h2>
        <p>‚Ä¢ Photos of Narendra Modi<br>
        ‚Ä¢ Photos of Dr. Manmohan Singh<br>
        ‚Ä¢ Positive words (wonderful, happy, etc.)<br>
        ‚Ä¢ Negative words (terrible, awful, etc.)</p>
        <div class="alert">
          <p><strong>Duration:</strong> 5-7 minutes. Respond as quickly as possible!</p>
        </div>
        <p style="text-align: center; margin-top: 30px; font-weight: 600;">
          ${isMobile ? 'Tap CONTINUE below to start' : 'Press any key to start'}
        </p>
      </div>
    </div>
  `,
  on_load: () => {
    if (isMobile) showControls('continue', 'START');
  },
  on_finish: () => hideControls()
});

// Instructions
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="page">
      <div class="card">
        <div class="label">Instructions</div>
        <h1>How to Respond</h1>
        <p>Categorize items using the ${isMobile ? 'E and I buttons at the bottom' : 'E and I keys'}.</p>
        <div class="cats">
          <div class="cat">
            <div class="cat-key">${isMobile ? 'Left Button' : 'Press E'}</div>
            <div class="cat-label">Left Category</div>
          </div>
          <div class="cat">
            <div class="cat-key">${isMobile ? 'Right Button' : 'Press I'}</div>
            <div class="cat-label">Right Category</div>
          </div>
        </div>
        <div class="alert">
          <p><strong>If wrong:</strong> An ‚úï appears. Press the ${isMobile ? 'other button' : 'correct key'}.</p>
        </div>
        <p style="text-align: center; margin-top: 30px; font-weight: 600;">
          ${isMobile ? 'Tap to begin' : 'Press Space to begin'}
        </p>
      </div>
    </div>
  `,
  choices: [' '],
  on_load: () => {
    if (isMobile) showControls('continue', 'BEGIN');
  },
  on_finish: () => hideControls()
});

// Block instruction
function blockInstr(title, left, right, reversed) {
  return {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div class="page">
        <div class="card">
          <div class="label">${reversed ? '‚ö†Ô∏è REVERSED' : 'Next Block'}</div>
          <h1>${title}</h1>
          ${reversed ? '<div class="alert"><p><strong>Categories switched!</strong></p></div>' : ''}
          <div class="cats">
            <div class="cat">
              <div class="cat-key">${isMobile ? 'E' : 'Press E'}</div>
              <div class="cat-label">${left}</div>
            </div>
            <div class="cat">
              <div class="cat-key">${isMobile ? 'I' : 'Press I'}</div>
              <div class="cat-label">${right}</div>
            </div>
          </div>
          <p style="text-align: center; margin-top: 30px; font-weight: 600;">
            ${isMobile ? 'Tap to start' : 'Press Space'}
          </p>
        </div>
      </div>
    `,
    choices: [' '],
    on_load: () => {
      if (isMobile) showControls('continue', 'START');
    },
    on_finish: () => hideControls()
  };
}

// Image trial
function imgTrial(block, leftCat, rightCat, leftShort, rightShort, crit) {
  return {
    type: jsPsychIatImage,
    stimulus: jsPsych.timelineVariable('stimulus'),
    stim_key_association: jsPsych.timelineVariable('key'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${leftCat} | I = ${rightCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: leftCat.split('/'),
    right_category_label: rightCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'image', critical: crit || false},
    on_load: () => {
      if (isMobile) showControls('choice', {left: leftShort, right: rightShort});
    }
  };
}

// Word trial
function wordTrial(block, leftCat, rightCat, leftShort, rightShort, crit) {
  return {
    type: jsPsychIatHtml,
    stimulus: jsPsych.timelineVariable('stimulus'),
    stim_key_association: jsPsych.timelineVariable('key'),
    html_when_wrong: '<span class="error-mark">‚úï</span>',
    bottom_instructions: `<p>E = ${leftCat} | I = ${rightCat}</p>`,
    force_correct_key_press: true,
    display_feedback: true,
    trial_duration: 3000,
    left_category_key: 'e',
    right_category_key: 'i',
    left_category_label: leftCat.split('/'),
    right_category_label: rightCat.split('/'),
    response_ends_trial: true,
    data: {block: block, type: 'word', critical: crit || false},
    on_load: () => {
      if (isMobile) showControls('choice', {left: leftShort, right: rightShort});
    }
  };
}

// BLOCK 1
timeline.push(blockInstr('Categorize Leaders', 'Modi', 'Manmohan', false));
timeline.push({
  timeline: [imgTrial('practice1', 'Modi', 'Manmohan', 'Modi', 'Manmohan')],
  timeline_variables: [
    ...MODI.map(img => ({stimulus: img, key: 'left'})),
    ...MANMOHAN.map(img => ({stimulus: img, key: 'right'}))
  ],
  randomize_order: true,
  repetitions: 2
});

// BLOCK 2
timeline.push(blockInstr('Categorize Words', 'Positive', 'Negative', false));
timeline.push({
  timeline: [wordTrial('practice2', 'Positive', 'Negative', 'Positive', 'Negative')],
  timeline_variables: [
    ...POSITIVE.map(w => ({stimulus: w, key: 'left'})),
    ...NEGATIVE.map(w => ({stimulus: w, key: 'right'}))
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 3
timeline.push(blockInstr('Combined', 'Modi or Positive', 'Manmohan or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...MODI.map(img => ({stimulus: img, key: 'left'})),
        ...MANMOHAN.map(img => ({stimulus: img, key: 'right'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice3', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg')],
      timeline_variables: [
        ...POSITIVE.map(w => ({stimulus: w, key: 'left'})),
        ...NEGATIVE.map(w => ({stimulus: w, key: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 4 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...MODI.map(img => ({stimulus: img, key: 'left'})),
        ...MANMOHAN.map(img => ({stimulus: img, key: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('compatible', 'Modi/Positive', 'Manmohan/Negative', 'Modi/Pos', 'Man/Neg', true)],
      timeline_variables: [
        ...POSITIVE.map(w => ({stimulus: w, key: 'left'})),
        ...NEGATIVE.map(w => ({stimulus: w, key: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// BLOCK 5
timeline.push(blockInstr('Categorize Leaders', 'Manmohan', 'Modi', true));
timeline.push({
  timeline: [imgTrial('practice4', 'Manmohan', 'Modi', 'Manmohan', 'Modi')],
  timeline_variables: [
    ...MODI.map(img => ({stimulus: img, key: 'right'})),
    ...MANMOHAN.map(img => ({stimulus: img, key: 'left'}))
  ],
  randomize_order: true,
  repetitions: 5
});

// BLOCK 6
timeline.push(blockInstr('Combined', 'Manmohan or Positive', 'Modi or Negative', false));
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...MODI.map(img => ({stimulus: img, key: 'right'})),
        ...MANMOHAN.map(img => ({stimulus: img, key: 'left'}))
      ],
      randomize_order: true
    },
    {
      timeline: [wordTrial('practice5', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg')],
      timeline_variables: [
        ...POSITIVE.map(w => ({stimulus: w, key: 'left'})),
        ...NEGATIVE.map(w => ({stimulus: w, key: 'right'}))
      ],
      randomize_order: true
    }
  ],
  randomize_order: true,
  repetitions: 1
});

// BLOCK 7 - CRITICAL
timeline.push({
  timeline: [
    {
      timeline: [imgTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...MODI.map(img => ({stimulus: img, key: 'right'})),
        ...MANMOHAN.map(img => ({stimulus: img, key: 'left'}))
      ],
      randomize_order: true,
      repetitions: 2
    },
    {
      timeline: [wordTrial('incompatible', 'Manmohan/Positive', 'Modi/Negative', 'Man/Pos', 'Modi/Neg', true)],
      timeline_variables: [
        ...POSITIVE.map(w => ({stimulus: w, key: 'left'})),
        ...NEGATIVE.map(w => ({stimulus: w, key: 'right'}))
      ],
      randomize_order: true,
      repetitions: 2
    }
  ],
  randomize_order: true
});

// Debrief
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="page">
      <div class="card">
        <div class="label">Almost Done</div>
        <h1>Thank You!</h1>
        <p>You've completed the IAT. The test measures automatic associations by comparing response times.</p>
        <div class="alert success">
          <p>Faster responses = stronger mental associations</p>
        </div>
        <p style="text-align: center; margin-top: 30px; font-weight: 600;">
          ${isMobile ? 'Tap to see results' : 'Press any key for results'}
        </p>
      </div>
    </div>
  `,
  on_load: () => {
    if (isMobile) showControls('continue', 'RESULTS');
  },
  on_finish: () => hideControls()
});

// RUN
jsPsych.run(timeline);
</script>
</html>
